<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DIB Jobs // Arti</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* ==========================================================================
   NEO-BRUTALIST CHAT WORKSPACE
   ========================================================================== */
:root {
    /* Colors */
    --ink-black: #1a1a2e;
    --deep-blue: #4a6a8a;
    --warm-cream: #f8f6f1;
    --card-white: #ffffff;
    --bg-blue: #e8f0f6;
    --accent-clay: #e07a5f;
    --accent-gold: #f2cc8f;
    --accent-olive: #81b29a;
    --accent-mint: #d4e8dc;
    
    /* Tokens */
    --border: 3px solid var(--ink-black);
    --radius: 12px;
    --shadow: 6px 6px 0 var(--ink-black);
    --shadow-sm: 3px 3px 0 var(--ink-black);
}

* { box-sizing: border-box; }
body { margin: 0; padding: 0; font-family: 'DM Sans', sans-serif; background: var(--bg-blue); color: var(--ink-black); height: 100vh; overflow: hidden; }
h1, h2, h3, h4, .mono { font-family: 'Space Mono', monospace; }

/* LAYOUT GRID */
.app-layout {
    display: grid;
    grid-template-columns: 400px 1fr; /* Chat fixed, Workspace fluid */
    height: 100vh;
    overflow: hidden;
}

/* ==========================================================================
   LEFT PANEL: CHAT STREAM
   ========================================================================== */
.chat-panel {
    background: var(--warm-cream);
    border-right: var(--border);
    display: flex;
    flex-direction: column;
    height: 100%;
    z-index: 10;
}

.chat-header {
    padding: 16px 20px;
    border-bottom: var(--border);
    background: var(--card-white);
    display: flex;
    align-items: center;
    gap: 12px;
}

.brand-text { font-family: 'Space Mono'; font-weight: 700; font-size: 16px; letter-spacing: -0.5px; }

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.message { display: flex; gap: 12px; animation: slideUp 0.3s ease; }
.message.user { flex-direction: row-reverse; }

/* Avatar - No Border as requested */
.avatar { 
    width: 36px; height: 36px; flex-shrink: 0; 
}
.avatar img { width: 100%; height: 100%; object-fit: contain; border-radius: 6px; }

.bubble {
    background: var(--card-white);
    border: 2px solid var(--ink-black);
    border-radius: var(--radius);
    border-top-left-radius: 2px;
    padding: 14px 18px;
    font-size: 14px;
    line-height: 1.5;
    box-shadow: var(--shadow-sm);
    max-width: 85%;
}

.message.user .bubble {
    background: var(--ink-black);
    color: white;
    border-radius: var(--radius);
    border-top-right-radius: 2px;
    box-shadow: -3px 3px 0 rgba(0,0,0,0.2);
}

.chat-input-area {
    padding: 16px;
    background: var(--card-white);
    border-top: var(--border);
}

.input-wrapper { display: flex; gap: 10px; }

textarea {
    flex: 1;
    border: 2px solid var(--ink-black);
    border-radius: 8px;
    padding: 12px;
    font-family: inherit;
    font-size: 14px;
    resize: none;
    height: 50px;
    outline: none;
    transition: box-shadow 0.2s;
}
textarea:focus { box-shadow: var(--shadow-sm); }

.send-btn {
    background: var(--ink-black);
    color: white;
    border: none;
    border-radius: 8px;
    width: 50px;
    cursor: pointer;
    font-family: 'Space Mono';
    font-weight: bold;
}
.send-btn:hover { background: var(--accent-blue); }

/* ==========================================================================
   RIGHT PANEL: WORKSPACE (Rich Tools)
   ========================================================================== */
.workspace-panel {
    background: var(--bg-blue);
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 24px;
}

/* Empty State */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    opacity: 0.5;
    text-align: center;
}

/* Workspace Components (Hidden initially) */
.workspace-content { display: none; max-width: 1000px; margin: 0 auto; width: 100%; }
.workspace-content.visible { display: block; }

/* Score Hero */
.score-hero {
    background: var(--ink-black);
    color: white;
    border-radius: var(--radius);
    padding: 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow);
    margin-bottom: 24px;
    border: var(--border);
}
.score-val { font-family: 'Space Mono'; font-size: 64px; font-weight: 700; line-height: 1; }
.score-meta h2 { margin: 0 0 4px 0; color: var(--accent-mint); font-size: 20px; }
.score-meta p { margin: 0; font-size: 14px; opacity: 0.8; }

/* Grid Cards */
.dash-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 24px;
}

.card {
    background: var(--card-white);
    border: var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 20px;
    display: flex;
    flex-direction: column;
}

.card h3 { font-size: 12px; text-transform: uppercase; margin: 0 0 12px 0; opacity: 0.6; }
.big-stat { font-family: 'Space Mono'; font-size: 28px; font-weight: 700; margin-bottom: 4px; }
.stat-sub { font-size: 12px; }

/* Lists (Strengths/Gaps) */
.fit-list { list-style: none; padding: 0; margin: 0; }
.fit-item {
    padding: 10px;
    border: 2px solid var(--ink-black);
    margin-bottom: 8px;
    border-radius: 6px;
    font-size: 13px;
    background: white;
}
.fit-item.match { border-left: 8px solid var(--accent-olive); }
.fit-item.gap { border-left: 8px solid var(--accent-clay); }

/* Tool Cards (Email, Interview) */
.tool-card {
    background: var(--warm-cream);
    border: var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    margin-bottom: 24px;
}
.tool-header {
    padding: 14px 20px;
    border-bottom: 2px solid var(--ink-black);
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    background: white;
    border-radius: 10px 10px 0 0;
}
.tool-body { padding: 20px; display: none; }
.tool-body.open { display: block; }

.email-box {
    background: white;
    border: 2px solid var(--ink-black);
    padding: 20px;
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    white-space: pre-wrap;
    margin-bottom: 12px;
}

.action-btn {
    background: var(--deep-blue);
    color: white;
    font-family: 'Space Mono';
    border: 2px solid var(--ink-black);
    padding: 10px 20px;
    cursor: pointer;
    box-shadow: 4px 4px 0 var(--ink-black);
    transition: transform 0.1s;
}
.action-btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 var(--ink-black); }

/* Quick Chips in Chat */
.chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
.chip {
    font-family: 'Space Mono'; font-size: 11px;
    background: var(--accent-mint); border: 2px solid var(--ink-black);
    padding: 6px 12px; border-radius: 20px; cursor: pointer;
}
.chip:hover { background: var(--ink-black); color: white; }

@keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* Responsive */
@media (max-width: 900px) {
    .app-layout { grid-template-columns: 1fr; grid-template-rows: 50% 50%; }
    .dash-grid { grid-template-columns: 1fr 1fr; }
}
</style>
</head>
<body>

<div class="app-layout">
    
    <section class="chat-panel">
        <div class="chat-header">
            <div class="avatar"><img src="arti.png" alt="A"></div>
            <div class="brand-text">DIB Jobs // Arti</div>
        </div>
        
        <div id="messages" class="chat-messages">
            </div>

        <div class="chat-input-area">
            <div class="input-wrapper">
                <textarea id="userInput" placeholder="Type here..." onkeydown="handleEnter(event)"></textarea>
                <button class="send-btn" onclick="handleSend()">-></button>
            </div>
        </div>
    </section>

    <section class="workspace-panel" id="workspacePanel">
        
        <div id="emptyState" class="empty-state">
            <div style="font-family:'Space Mono'; font-size:60px; margin-bottom:10px;">?</div>
            <h3>Ready to Work</h3>
            <p>Chat with Arti to analyze a job.<br>Your tools will appear here.</p>
        </div>

        <div id="dashboardContent" class="workspace-content">
            
            <div class="score-hero">
                <div>
                    <div class="score-val"><span id="scoreValue">--</span>%</div>
                    <div class="mono" style="font-size:12px; opacity:0.6; letter-spacing:2px;">MATCH SCORE</div>
                </div>
                <div class="score-meta" style="text-align:right;">
                    <h2 id="jobVerdict">Analyzing...</h2>
                    <p><strong id="jobTitle">--</strong></p>
                    <p id="jobCompany">--</p>
                </div>
            </div>

            <div class="dash-grid">
                <div class="card">
                    <h3>Market Salary</h3>
                    <div class="big-stat" id="salaryStat">--</div>
                    <div class="stat-sub" id="salarySub">Loading intel...</div>
                </div>
                <div class="card">
                    <h3>Keywords</h3>
                    <div class="big-stat" id="kwStat">--</div>
                    <div class="stat-sub"><span id="kwMissing">0</span> missing criticals</div>
                </div>
                <div class="card">
                    <h3>Competition</h3>
                    <div class="big-stat" id="compStat">--</div>
                    <div class="stat-sub" id="compSub">Loading intel...</div>
                </div>
            </div>

            <div class="dash-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="card">
                    <h3>Top Strengths</h3>
                    <div id="strengthsList"></div>
                </div>
                <div class="card">
                    <h3>Critical Gaps</h3>
                    <div id="gapsList"></div>
                </div>
            </div>

            <div class="mono" style="margin: 20px 0 10px 0; font-weight:700; opacity:0.5;">APPLICATION TOOLKIT</div>

            <div class="tool-card">
                <div class="tool-header" onclick="toggleTool('emailTool')">
                    <span class="mono" style="font-weight:700;">// INTRO EMAIL GENERATOR</span>
                    <span>+</span>
                </div>
                <div id="emailTool" class="tool-body">
                    <p style="font-size:13px; margin-bottom:10px;">A tailored email to the hiring manager highlighting your specific fit.</p>
                    <div id="emailOutput" class="email-box" style="display:none;"></div>
                    <button id="genEmailBtn" class="action-btn" onclick="generateEmail()">Generate Email</button>
                    <button id="copyEmailBtn" class="action-btn" style="display:none; background:white; color:black;" onclick="copyEmail()">Copy Text</button>
                </div>
            </div>

            <div class="tool-card">
                <div class="tool-header" onclick="toggleTool('interviewTool')">
                    <span class="mono" style="font-weight:700;">// INTERVIEW PREP</span>
                    <span>+</span>
                </div>
                <div id="interviewTool" class="tool-body">
                    <div id="interviewQuestions"></div>
                </div>
            </div>

        </div>
    </section>
</div>

<script>
// ==========================================================================
// CONFIG & STATE
// ==========================================================================
const API_ENDPOINT = 'https://76unm1rlj0.execute-api.us-east-1.amazonaws.com/default/grumpy2';
let appState = {
    step: 'INIT', // INIT -> RESUME -> JD -> DASHBOARD
    resumeText: '',
    jdText: '',
    analysis: null,
    chatHistory: []
};

// ==========================================================================
// INIT
// ==========================================================================
document.addEventListener('DOMContentLoaded', () => {
    // Initial Greeting
    setTimeout(() => {
        addMessage('arti', "Welcome to the DIB Jobs workspace. I'm Arti.");
        setTimeout(() => {
            addMessage('arti', "I'll help you analyze fit, generate emails, and prep for interviews. To start, please **paste your resume**.");
            appState.step = 'RESUME';
        }, 800);
    }, 500);
});

// ==========================================================================
// CHAT LOGIC
// ==========================================================================
const msgContainer = document.getElementById('messages');
const userInput = document.getElementById('userInput');

function addMessage(sender, text, chips = []) {
    const div = document.createElement('div');
    div.className = `message ${sender}`;
    
    let avatar = sender === 'arti' ? '<div class="avatar"><img src="arti.png" alt="A"></div>' : '';
    
    // Formatting
    let htmlContent = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Add Chips if provided
    let chipsHtml = '';
    if (chips.length > 0) {
        chipsHtml = `<div class="chip-container">
            ${chips.map(c => `<div class="chip" onclick="handleChip('${c.action}')">${c.label}</div>`).join('')}
        </div>`;
    }

    div.innerHTML = `
        ${avatar}
        <div class="bubble">
            <div>${htmlContent}</div>
            ${chipsHtml}
        </div>
    `;
    
    msgContainer.appendChild(div);
    msgContainer.scrollTop = msgContainer.scrollHeight;
    return div;
}

function showTyping() {
    const id = 'typ_' + Date.now();
    addMessage('arti', `<span id="${id}">Thinking...</span>`);
    return id;
}

function removeTyping(id) {
    const el = document.getElementById(id);
    if (el) el.closest('.message').remove();
}

function handleEnter(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
    }
}

async function handleSend() {
    const text = userInput.value.trim();
    if (!text) return;
    
    userInput.value = '';
    addMessage('user', text);

    // STATE MACHINE
    if (appState.step === 'RESUME') {
        if (text.length < 50) {
            addMessage('arti', "That looks too short. Please paste the full text.");
            return;
        }
        appState.resumeText = text;
        appState.step = 'JD';
        addMessage('arti', "Got it. Now **paste the Job Description**.");
        
    } else if (appState.step === 'JD') {
        if (text.length < 20) {
            addMessage('arti', "Please paste a valid job description.");
            return;
        }
        appState.jdText = text;
        appState.step = 'ANALYZING';
        await performAnalysis();
        
    } else if (appState.step === 'DASHBOARD') {
        // Normal chat mode
        await handleChatQuery(text);
    }
}

// ==========================================================================
// CORE ANALYSIS
// ==========================================================================
async function performAnalysis() {
    const tid = showTyping();
    try {
        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            body: JSON.stringify({
                request_type: 'resume_match',
                job_description: appState.jdText,
                resume_text: appState.resumeText
            })
        });
        const data = await response.json();
        removeTyping(tid);
        
        appState.analysis = data;
        appState.step = 'DASHBOARD';
        
        renderDashboard(data);
        
        let verdict = data.score >= 75 ? "Strong match." : "Some gaps found.";
        addMessage('arti', `${verdict} I've populated your **Toolkit** on the right. What would you like to do?`, [
            {label: "Draft Intro Email", action: "email"},
            {label: "Explain Gaps", action: "gaps"},
            {label: "Salary Check", action: "salary"}
        ]);
        
        // Fetch Intel in background
        fetchMarketIntel(data.job_title, data.company);
        
    } catch (e) {
        removeTyping(tid);
        addMessage('arti', "Error analyzing job. Please try again.");
        appState.step = 'JD';
    }
}

// ==========================================================================
// DASHBOARD RENDERING
// ==========================================================================
function renderDashboard(data) {
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('dashboardContent').classList.add('visible');
    
    // Hero
    document.getElementById('scoreValue').textContent = data.score;
    document.getElementById('jobTitle').textContent = data.job_title;
    document.getElementById('jobCompany').textContent = data.company;
    document.getElementById('jobVerdict').textContent = data.verdict;
    
    // Strengths
    const matches = data.analysis.filter(a => a.startsWith('Match:'));
    document.getElementById('strengthsList').innerHTML = matches.slice(0, 4).map(m => 
        `<div class="fit-item match">${m.replace('Match:', '').trim()}</div>`
    ).join('');
    
    // Gaps
    const gaps = data.analysis.filter(a => a.startsWith('Gap:'));
    document.getElementById('gapsList').innerHTML = gaps.slice(0, 3).map(g => 
        `<div class="fit-item gap">${g.replace('Gap:', '').trim()}</div>`
    ).join('');
    
    // Stats
    const kw = data.keywords || [];
    const missing = kw.filter(k => !k.in_resume).length;
    document.getElementById('kwStat').textContent = Math.round(((kw.length - missing)/kw.length)*100) + '%';
    document.getElementById('kwMissing').textContent = missing;
    
    // Interview Qs
    const qs = data.interview_questions || [];
    document.getElementById('interviewQuestions').innerHTML = qs.map(q => 
        `<div style="margin-bottom:12px; font-size:13px;">
            <strong>Q: ${q.question}</strong><br>
            <em style="opacity:0.7">Tip: ${q.suggested_answer}</em>
        </div>`
    ).join('');
}

// ==========================================================================
// MARKET INTEL & TOOLS
// ==========================================================================
async function fetchMarketIntel(title, company) {
    try {
        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            body: JSON.stringify({
                request_type: 'market_intel',
                job_description: appState.jdText,
                job_title: title,
                company: company
            })
        });
        const data = await response.json();
        
        if (data.salary_intel) {
            document.getElementById('salaryStat').textContent = `$${data.salary_intel.mid}k`;
            document.getElementById('salarySub').textContent = `$${data.salary_intel.low}k - $${data.salary_intel.high}k`;
            appState.analysis.market_intel = data.salary_intel;
        }
        if (data.competition) {
            document.getElementById('compStat').textContent = data.competition.level;
            document.getElementById('compSub').textContent = "Competition Level";
        }
    } catch(e) {}
}

async function generateEmail() {
    const btn = document.getElementById('genEmailBtn');
    btn.textContent = "Generating...";
    try {
        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            body: JSON.stringify({
                request_type: 'generate_intro_email',
                job_description: appState.jdText,
                resume_text: appState.resumeText,
                analysis_data: appState.analysis
            })
        });
        const data = await response.json();
        document.getElementById('emailOutput').style.display = 'block';
        document.getElementById('emailOutput').textContent = data.intro_email;
        btn.style.display = 'none';
        document.getElementById('copyEmailBtn').style.display = 'inline-block';
        
        // Open the card if closed
        document.getElementById('emailTool').classList.add('open');
        
    } catch(e) { btn.textContent = "Error. Try again."; }
}

// ==========================================================================
// CHIP & INTERACTION
// ==========================================================================
function handleChip(action) {
    if (action === 'email') {
        toggleTool('emailTool');
        document.getElementById('workspacePanel').scrollTop = document.querySelector('.tool-card').offsetTop;
        if(document.getElementById('emailOutput').style.display === 'none') generateEmail();
    }
    else if (action === 'gaps') handleChatQuery("How do I fix my gaps?");
    else if (action === 'salary') handleChatQuery("Is the salary fair?");
}

function toggleTool(id) {
    document.getElementById(id).classList.toggle('open');
}

async function handleChatQuery(text) {
    addMessage('user', text); // Ensure user sees their click as a message
    const tid = showTyping();
    try {
        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            body: JSON.stringify({
                request_type: 'ask_expert',
                question: text,
                job_description: appState.jdText,
                resume_text: appState.resumeText,
                analysis_data: appState.analysis,
                chat_history: appState.chatHistory
            })
        });
        const data = await response.json();
        removeTyping(tid);
        addMessage('arti', data.response);
        appState.chatHistory.push({role:'user', content:text}, {role:'assistant', content:data.response});
    } catch(e) { removeTyping(tid); }
}

function copyEmail() {
    navigator.clipboard.writeText(document.getElementById('emailOutput').textContent);
    alert("Copied!");
}
</script>
</body>
</html>