<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arti // DIB Career Coach</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* ==========================================================================
   ARTI - CHAT FIRST UI
   ========================================================================== */
:root {
    --ink-black: #1a1a2e;
    --off-white: #f8f6f1;
    --pure-white: #ffffff;
    --accent-blue: #4a6a8a;
    --accent-mint: #d4e8dc; /* Arti's Color */
    --accent-clay: #e07a5f;
    --accent-olive: #81b29a;
    --border: 2px solid var(--ink-black);
    --radius: 12px;
    --shadow: 4px 4px 0 var(--ink-black);
}

* { box-sizing: border-box; }
body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--off-white); height: 100vh; display: flex; overflow: hidden; color: var(--ink-black); }

/* LAYOUT */
.app-container { display: flex; width: 100%; height: 100%; }

/* SIDEBAR DASHBOARD (Hidden initially) */
.dashboard-panel {
    width: 0;
    background: #e8f0f6;
    border-right: var(--border);
    overflow-y: auto;
    transition: width 0.3s ease;
    flex-shrink: 0;
}
.dashboard-panel.open { width: 400px; }
.dashboard-content { padding: 20px; width: 400px; display: none; }
.dashboard-panel.open .dashboard-content { display: block; }

/* CHAT AREA */
.chat-main { flex: 1; display: flex; flex-direction: column; position: relative; }

/* HEADER */
header {
    padding: 16px 24px;
    border-bottom: var(--border);
    background: var(--pure-white);
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 10;
}
.brand { display: flex; align-items: center; gap: 12px; font-family: 'Space Mono', monospace; font-weight: 700; font-size: 18px; }
.brand img { width: 32px; height: 32px; border-radius: 6px; border: 2px solid var(--ink-black); }
.dash-toggle { 
    display: none; /* Hidden until data exists */
    cursor: pointer; 
    font-family: 'Space Mono', monospace; 
    font-size: 12px; 
    background: var(--ink-black); 
    color: white; 
    padding: 8px 16px; 
    border-radius: 20px; 
}

/* MESSAGES */
.messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    scroll-behavior: smooth;
}

.message { display: flex; gap: 16px; max-width: 800px; margin: 0 auto; width: 100%; animation: fadeIn 0.3s ease; }
.message.user { flex-direction: row-reverse; }

.avatar { width: 40px; height: 40px; border-radius: 8px; border: 2px solid var(--ink-black); flex-shrink: 0; overflow: hidden; }
.avatar img { width: 100%; height: 100%; object-fit: cover; }
.avatar.user-av { background: var(--ink-black); display: grid; place-items: center; color: white; font-family: 'Space Mono'; }

.bubble {
    background: var(--pure-white);
    border: var(--border);
    border-radius: var(--radius);
    padding: 16px 20px;
    font-size: 15px;
    line-height: 1.6;
    box-shadow: var(--shadow);
    max-width: 80%;
    position: relative;
}

.message.arti .bubble { background: var(--pure-white); border-top-left-radius: 2px; }
.message.user .bubble { background: var(--ink-black); color: white; border-top-right-radius: 2px; border-color: var(--ink-black); }

/* SYSTEM/WIDGET MESSAGE */
.message.widget .bubble {
    background: var(--off-white);
    width: 100%;
    max-width: 100%;
    border-style: dashed;
    box-shadow: none;
}

/* INPUT AREA */
.input-area {
    padding: 20px;
    background: var(--pure-white);
    border-top: var(--border);
    display: flex;
    justify-content: center;
}
.input-wrapper {
    max-width: 800px;
    width: 100%;
    position: relative;
    display: flex;
    gap: 10px;
}
textarea {
    width: 100%;
    padding: 16px;
    border: var(--border);
    border-radius: 12px;
    font-family: inherit;
    font-size: 15px;
    resize: none;
    height: 60px;
    outline: none;
    box-shadow: 4px 4px 0 rgba(0,0,0,0.1);
}
textarea:focus { box-shadow: 4px 4px 0 var(--accent-mint); }

.send-btn {
    width: 60px;
    height: 60px;
    background: var(--ink-black);
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: bold;
    display: grid;
    place-items: center;
    transition: transform 0.1s;
}
.send-btn:active { transform: scale(0.95); }
.send-btn svg { width: 24px; height: 24px; fill: white; }

/* QUICK ACTIONS */
.quick-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
}
.chip {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    background: var(--accent-mint);
    border: 2px solid var(--ink-black);
    padding: 6px 12px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
}
.chip:hover { background: var(--ink-black); color: white; }

/* TYPING INDICATOR */
.typing { display: flex; gap: 4px; padding: 10px 14px; }
.dot { width: 6px; height: 6px; background: var(--ink-black); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
.dot:nth-child(1) { animation-delay: -0.32s; }
.dot:nth-child(2) { animation-delay: -0.16s; }

/* DASHBOARD COMPONENTS */
.score-card { text-align: center; margin-bottom: 24px; padding: 20px; background: var(--ink-black); color: white; border-radius: var(--radius); }
.score-big { font-family: 'Space Mono'; font-size: 48px; font-weight: 700; line-height: 1; display: block; }
.score-label { font-family: 'Space Mono'; font-size: 10px; opacity: 0.7; letter-spacing: 2px; text-transform: uppercase; }

.section-title { font-family: 'Space Mono'; font-size: 12px; font-weight: 700; text-transform: uppercase; margin-bottom: 12px; margin-top: 24px; border-bottom: 2px solid rgba(0,0,0,0.1); padding-bottom: 5px; }

.list-item { 
    background: white; border: 2px solid var(--ink-black); 
    padding: 10px; margin-bottom: 8px; border-radius: 8px; font-size: 13px;
    box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
}
.list-item.good { border-left: 6px solid var(--accent-olive); }
.list-item.bad { border-left: 6px solid var(--accent-clay); }

@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

/* UTILS */
.hidden { display: none !important; }
.markdown-body p { margin-top: 0; margin-bottom: 10px; }
.markdown-body p:last-child { margin-bottom: 0; }
.markdown-body ul { padding-left: 20px; margin: 0; }

/* MOBILE */
@media(max-width: 768px) {
    .dashboard-panel { position: absolute; right: 0; top: 0; bottom: 0; width: 85%; z-index: 20; transform: translateX(100%); transition: transform 0.3s; box-shadow: -10px 0 20px rgba(0,0,0,0.2); }
    .dashboard-panel.open { transform: translateX(0); width: 85%; }
    .message { max-width: 100%; }
    .bubble { padding: 12px 16px; font-size: 14px; }
}
</style>
</head>
<body>

<div class="app-container">
    
    <div id="dashboard" class="dashboard-panel">
        <div class="dashboard-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <span class="brand">Analysis Data</span>
                <button onclick="toggleDashboard()" style="background:none; border:none; font-size:20px; cursor:pointer;">Ã—</button>
            </div>

            <div class="score-card">
                <span class="score-big" id="dashScore">--</span>
                <span class="score-label">Match Score</span>
            </div>

            <div class="section-title">Details</div>
            <div style="font-size:13px; margin-bottom:10px;">
                <strong>Role:</strong> <span id="dashRole">--</span><br>
                <strong>Company:</strong> <span id="dashCompany">--</span>
            </div>

            <div class="section-title">Top Strengths</div>
            <div id="dashMatches"></div>

            <div class="section-title">Critical Gaps</div>
            <div id="dashGaps"></div>

            <div class="section-title">Market Intel</div>
            <div id="dashIntel" class="list-item">Loading market data...</div>
            
            <div class="section-title">Tools</div>
            <button onclick="triggerAction('Generate Email')" class="chip" style="width:100%; text-align:center; margin-bottom:8px;">Generate Intro Email</button>
            <button onclick="triggerAction('Interview Prep')" class="chip" style="width:100%; text-align:center;">Interview Prep</button>
        </div>
    </div>

    <div class="chat-main">
        <header>
            <div class="brand">
                <img src="arti.png" alt="A">
                <span>DIB Jobs / Arti</span>
            </div>
            <div id="dashToggle" class="dash-toggle" onclick="toggleDashboard()">View Dashboard</div>
        </header>

        <div id="messages" class="messages-container">
            </div>

        <div class="input-area">
            <div class="input-wrapper">
                <textarea id="userInput" placeholder="Type a message..." onkeydown="handleEnter(event)"></textarea>
                <button class="send-btn" onclick="handleSend()">
                    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ==========================================================================
// ARTI - CHATBOT LOGIC
// ==========================================================================
const API_ENDPOINT = 'https://76unm1rlj0.execute-api.us-east-1.amazonaws.com/default/grumpy2';
const STORAGE_KEY = 'arti_context_v1';

// State Management
let appState = {
    step: 'INIT', // INIT, RESUME, JD, CHAT
    resumeText: '',
    jdText: '',
    analysis: null,
    chatHistory: []
};

// DOM Elements
const msgContainer = document.getElementById('messages');
const userInput = document.getElementById('userInput');
const dashPanel = document.getElementById('dashboard');
const dashToggle = document.getElementById('dashToggle');

// Init
document.addEventListener('DOMContentLoaded', () => {
    // Check for saved state (optional persistence)
    // For now, clean start
    setTimeout(() => {
        addMessage('arti', "Hi, I'm Arti, your DIB career coach. I can help you analyze a job fit, find salary data, and write your application.");
        setTimeout(() => {
            addMessage('arti', "To get started, please **paste your resume** text here.");
            appState.step = 'RESUME';
        }, 600);
    }, 500);
});

// ==========================================================================
// UI FUNCTIONS
// ==========================================================================

function addMessage(sender, text, isWidget = false) {
    const div = document.createElement('div');
    div.className = `message ${sender} ${isWidget ? 'widget' : ''}`;
    
    let avatarHtml = '';
    if (!isWidget) {
        if (sender === 'arti') avatarHtml = `<div class="avatar"><img src="arti.png" alt="A"></div>`;
        else avatarHtml = `<div class="avatar user-av">ME</div>`;
    }

    // Parse simple markdown (bold/links/newlines)
    let formattedText = text
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

    div.innerHTML = `
        ${avatarHtml}
        <div class="bubble">
            <div class="markdown-body">${formattedText}</div>
            ${isWidget ? '<div class="quick-actions" id="last-actions"></div>' : ''}
        </div>
    `;
    
    msgContainer.appendChild(div);
    scrollToBottom();
    return div;
}

function showTyping() {
    const id = 'typing-' + Date.now();
    const div = document.createElement('div');
    div.id = id;
    div.className = 'message arti';
    div.innerHTML = `
        <div class="avatar"><img src="arti.png" alt="A"></div>
        <div class="bubble">
            <div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        </div>
    `;
    msgContainer.appendChild(div);
    scrollToBottom();
    return id;
}

function removeTyping(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
}

function scrollToBottom() {
    msgContainer.scrollTop = msgContainer.scrollHeight;
}

function handleEnter(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
    }
}

function toggleDashboard() {
    dashPanel.classList.toggle('open');
}

// ==========================================================================
// CORE LOGIC FLOW
// ==========================================================================

async function handleSend() {
    const text = userInput.value.trim();
    if (!text) return;
    
    userInput.value = '';
    addMessage('user', text);

    // STATE MACHINE
    if (appState.step === 'RESUME') {
        if (text.length < 50) {
            addMessage('arti', "That looks a bit short for a resume. Can you paste the full text?");
            return;
        }
        appState.resumeText = text;
        appState.step = 'JD';
        const loadId = showTyping();
        setTimeout(() => {
            removeTyping(loadId);
            addMessage('arti', "Got it. Now, please **paste the Job Description** (or a URL) you want to analyze.");
        }, 800);
        
    } else if (appState.step === 'JD') {
        if (text.length < 20) {
            addMessage('arti', "That seems too short. Please paste the job description.");
            return;
        }
        appState.jdText = text;
        appState.step = 'ANALYZING'; // Prevent double submit
        
        await performAnalysis();
        
    } else if (appState.step === 'CHAT') {
        await handleChatQuery(text);
    }
}

// ==========================================================================
// API INTERACTIONS
// ==========================================================================

async function performAnalysis() {
    const typingId = showTyping();
    
    try {
        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                request_type: 'resume_match',
                job_description: appState.jdText,
                resume_text: appState.resumeText
            })
        });
        
        const data = await response.json();
        removeTyping(typingId);
        
        if (data.error) throw new Error(data.error);

        appState.analysis = data;
        appState.step = 'CHAT';

        // Render Results
        renderAnalysisResult(data);
        
        // Fetch Market Intel in background
        fetchMarketIntel(data.job_title, data.company);

    } catch (e) {
        removeTyping(typingId);
        addMessage('arti', "Sorry, I had trouble analyzing that. " + e.message);
        appState.step = 'JD'; // Go back a step
    }
}

function renderAnalysisResult(data) {
    // Populate Dashboard
    document.getElementById('dashScore').textContent = data.score + '%';
    document.getElementById('dashRole').textContent = data.job_title || 'Role';
    document.getElementById('dashCompany').textContent = data.company || 'Company';
    
    const matches = data.analysis.filter(a => a.startsWith('Match:'));
    const gaps = data.analysis.filter(a => a.startsWith('Gap:'));
    
    document.getElementById('dashMatches').innerHTML = matches.slice(0,3).map(m => 
        `<div class="list-item good">${m.replace('Match:', '').trim()}</div>`
    ).join('');
    
    document.getElementById('dashGaps').innerHTML = gaps.slice(0,3).map(g => 
        `<div class="list-item bad">${g.replace('Gap:', '').trim()}</div>`
    ).join('');

    // Show Dashboard Toggle
    dashToggle.style.display = 'block';

    // Chat Message
    let verdict = "";
    if (data.score >= 80) verdict = "You are a **strong match** for this role!";
    else if (data.score >= 60) verdict = "This is a **solid opportunity**, but there are some gaps we need to address.";
    else verdict = "This is a **stretch role**. We'll need a strong strategy to win this.";

    addMessage('arti', `${verdict} I've generated a full breakdown in the dashboard.`);
    
    // Add Buttons to the chat stream
    const controls = addMessage('arti', "How would you like to proceed?", true);
    const actions = controls.querySelector('.quick-actions');
    actions.innerHTML = `
        <div class="chip" onclick="triggerAction('Generate Email')">Draft Intro Email</div>
        <div class="chip" onclick="triggerAction('Salary')">Salary Estimate</div>
        <div class="chip" onclick="triggerAction('Gap Strategy')">Fix My Gaps</div>
    `;
    
    // Auto-open dashboard on mobile/desktop appropriately
    if(window.innerWidth > 768) dashPanel.classList.add('open');
}

async function fetchMarketIntel(title, company) {
    try {
        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            body: JSON.stringify({
                request_type: 'market_intel',
                job_description: appState.jdText,
                job_title: title,
                company: company
            })
        });
        const data = await response.json();
        
        // Update Dashboard
        if (data.salary_intel) {
            document.getElementById('dashIntel').innerHTML = `
                <strong>Est. Salary:</strong> $${data.salary_intel.low}k - $${data.salary_intel.high}k<br>
                <strong>Competition:</strong> ${data.competition?.level || 'Unknown'}
            `;
            // Save to state for chat context
            if(appState.analysis) appState.analysis.market_intel = data;
        }
    } catch(e) { console.log("Intel failed", e); }
}

async function handleChatQuery(text) {
    const typingId = showTyping();
    try {
        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            body: JSON.stringify({
                request_type: 'ask_expert',
                question: text,
                job_description: appState.jdText,
                resume_text: appState.resumeText,
                analysis_data: appState.analysis,
                chat_history: appState.chatHistory
            })
        });
        const data = await response.json();
        removeTyping(typingId);
        
        addMessage('arti', data.response);
        
        // Update History
        appState.chatHistory.push({role: 'user', content: text});
        appState.chatHistory.push({role: 'assistant', content: data.response});
        
    } catch (e) {
        removeTyping(typingId);
        addMessage('arti', "I'm having trouble connecting. Try again?");
    }
}

// ==========================================================================
// QUICK ACTIONS
// ==========================================================================

function triggerAction(action) {
    if (action === 'Generate Email') {
        const loadId = showTyping();
        fetch(API_ENDPOINT, {
            method: 'POST',
            body: JSON.stringify({
                request_type: 'generate_intro_email',
                job_description: appState.jdText,
                resume_text: appState.resumeText,
                analysis_data: appState.analysis
            })
        }).then(r => r.json()).then(data => {
            removeTyping(loadId);
            addMessage('arti', "**Here is a draft intro email for you:**");
            addMessage('arti', `<div style="white-space:pre-wrap; font-family:monospace; font-size:12px; background:#f0f0f0; padding:10px;">${data.intro_email}</div>`);
        });
    }
    
    if (action === 'Salary') {
        handleChatQuery("What is the estimated salary for this role and is it fair?");
    }
    
    if (action === 'Gap Strategy') {
        handleChatQuery("How should I address the biggest gaps in my resume for this specific job?");
    }
    
    if (action === 'Interview Prep') {
        handleChatQuery("Give me 3 tough interview questions they will ask me and bullet points on how to answer them.");
    }
}

</script>
</body>
</html>