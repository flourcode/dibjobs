<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DIB Jobs // Defense Industrial Base Jobs</title>
    <meta name="description" content="A job matching and application toolkit built for Defense Industrial Base professionals.">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* ==========================================================================
   NEO-BRUTALIST STYLES (Preserved from Source)
   ========================================================================== */
:root{--deep-blue:#4a6a8a;--soft-blue:#93b5d9;--pale-blue:#c8dae8;--warm-cream:#f8f6f1;--bg-cream:var(--warm-cream);--card-white:#fff;--ink-black:#3d4f5f;--accent-mint:var(--pale-blue);--accent-olive:var(--soft-blue);--accent-clay:#d4918a;--accent-gold:#e8c992;--accent-blue:var(--soft-blue);--border-thick:2px;--shadow-hard:5px 5px 0px var(--ink-black);--shadow-hover:2px 2px 0px var(--ink-black);--radius:6px}
*{margin:0;padding:0;box-sizing:border-box}
body{background-color:var(--card-white);color:var(--ink-black);font-family:DM Sans,sans-serif;line-height:1.6;min-height:100vh;padding-bottom:80px}
.mono,h1,h2,h3{font-family:Space Mono,monospace}

/* HEADER */
header{background:var(--card-white);padding:16px 24px; border-bottom: var(--border-thick) solid var(--ink-black);}
.brand{display:flex;align-items:center;gap:14px}
.logo-icon{width:44px;height:44px;flex-shrink:0}
.app-title{font-size:22px;font-weight:700;letter-spacing:-.5px;line-height:1.1;font-family:Space Mono,monospace;text-transform:uppercase;color:var(--ink-black)}
.app-subtitle{font-family:Space Mono,monospace;text-transform:uppercase;color:var(--ink-black);font-size:9px;letter-spacing:.5px}

/* MAIN LAYOUT */
main{max-width:1200px;margin:20px auto;padding:0 20px}

/* CARDS */
.card{background:var(--card-white);border:var(--border-thick) solid var(--ink-black);border-radius:var(--radius);box-shadow:var(--shadow-hard);margin-bottom:32px;overflow:hidden;transition:transform .2s ease}
.card-header{background:var(--accent-mint);border-bottom:var(--border-thick) solid var(--ink-black);padding:16px 24px;justify-content:space-between;display:flex;align-items:center}
.card-title{font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;gap:8px;display:flex;align-items:center}
.card-body{padding:32px}

/* ARTI CHAT CONSOLE (NEW - Chat Forward) */
.arti-console {
    background: var(--warm-cream);
    display: flex;
    flex-direction: column;
    height: 400px; /* Fixed height for chat focus */
}
.console-messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}
.msg-row { display: flex; gap: 12px; align-items: flex-start; }
.msg-row.user { flex-direction: row-reverse; }
.msg-avatar { width: 40px; height: 40px; flex-shrink: 0; }
.msg-avatar img { width: 100%; height: 100%; object-fit: contain; } /* Border removed per request */
.msg-bubble {
    background: var(--card-white);
    border: 2px solid var(--ink-black);
    padding: 14px 18px;
    border-radius: 12px;
    border-top-left-radius: 0;
    font-size: 14px;
    max-width: 85%;
    box-shadow: 3px 3px 0 rgba(0,0,0,0.05);
}
.msg-row.user .msg-bubble {
    background: var(--ink-black);
    color: white;
    border-radius: 12px;
    border-top-right-radius: 0;
}
.console-input-area {
    padding: 16px;
    background: var(--card-white);
    border-top: 2px solid var(--ink-black);
    display: flex;
    gap: 12px;
}
.console-input {
    flex: 1;
    border: 2px solid var(--ink-black);
    padding: 12px;
    font-family: 'Space Mono';
    font-size: 14px;
    border-radius: 6px;
}
.console-send {
    background: var(--ink-black);
    color: white;
    border: none;
    font-family: 'Space Mono';
    font-weight: bold;
    padding: 0 24px;
    border-radius: 6px;
    cursor: pointer;
}
.console-send:hover { background: var(--deep-blue); }

/* CHIPS (Quick Actions) */
.chat-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
.chip {
    font-family: 'Space Mono'; font-size: 11px; font-weight: 700;
    background: var(--accent-mint); border: 2px solid var(--ink-black);
    padding: 6px 12px; border-radius: 20px; cursor: pointer;
    transition: all 0.1s;
}
.chip:hover { transform: translateY(-2px); box-shadow: 2px 2px 0 var(--ink-black); }

/* INPUTS */
textarea{width:100%;min-height:160px;padding:20px;font-family:Space Mono,monospace;font-size:14px;border:var(--border-thick) solid var(--ink-black);border-radius:var(--radius);background:#fafafa;resize:vertical}
textarea:focus{outline:none;background:#fff;box-shadow:4px 4px 0 rgba(0,0,0,.1);border-color:var(--ink-black)}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 24px;font-family:Space Mono,monospace;font-weight:700;font-size:14px;text-transform:uppercase;color:var(--ink-black);background:var(--card-white);border:var(--border-thick) solid var(--ink-black);border-radius:var(--radius);cursor:pointer;box-shadow:var(--shadow-hard);transition:all .1s}
.btn:hover:not(:disabled){transform:translate(-2px,-2px);box-shadow:7px 7px 0 var(--ink-black)}
.btn-primary{background:var(--accent-mint)}
.btn-secondary{background:var(--card-white)}
.btn:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none;}

/* UTILS */
.section-label{font-family:Space Mono,monospace;font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.hero-grid{display:grid;grid-template-columns:200px 1fr;border-bottom:var(--border-thick) solid var(--ink-black)}
.score-box{background:var(--ink-black);color:var(--card-white);padding:40px 20px;text-align:center;display:flex;flex-direction:column;justify-content:center}
.score-val{font-size:80px;line-height:1;font-weight:700;font-family:Space Mono}
.score-label{font-family:Space Mono;text-transform:uppercase;font-size:12px;letter-spacing:2px;opacity:.8;margin-top:10px}
.verdict-box{padding:32px;display:flex;flex-direction:column;justify-content:center;background:var(--bg-cream)}

/* INTEL & KITS */
.intel-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-bottom:24px}
.intel-panel{background:var(--bg-cream);border:2px solid var(--ink-black);padding:20px;border-radius:var(--radius)}
.intel-value{font-family:Space Mono; font-weight:700; font-size:24px; margin-bottom:4px;}
.collapsible-card.collapsed .collapsible-content{display:none}
.collapsible-trigger{cursor:pointer;}
.collapsible-content{border-top:var(--border-thick) solid var(--ink-black)}
.kit-section{padding:20px 0}
.kit-section-title{font-family:Space Mono; font-size:12px; font-weight:700; text-transform:uppercase; margin-bottom:12px;}

/* TRACKER */
.tracker-table{width:100%;border-collapse:collapse;font-size:13px}
.tracker-table td,.tracker-table th{padding:10px 8px;border:2px solid var(--ink-black)}
.tracker-table th{background:var(--bg-cream);font-family:Space Mono; font-size:10px; text-transform:uppercase;}

/* MOBILE */
@media (max-width:768px){
    .hero-grid{grid-template-columns:1fr}
    .score-box{padding:20px;flex-direction:row;gap:20px;align-items:center}
    .score-val{font-size:48px}
    .card-body{padding:20px}
    header{padding:16px}
}

/* ERROR TOAST */
.error-toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:var(--accent-clay);color:var(--ink-black);padding:16px 24px;border:2px solid var(--ink-black);border-radius:6px;box-shadow:5px 5px 0 var(--ink-black);display:none;z-index:999;}
.error-toast.show{display:block;}
</style>
</head>
<body>

<header>
    <div class="brand">
        <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
            <polygon points="55,8 90,35 77,78 33,78 20,35" fill="var(--ink-black)"/>
            <polygon points="50,12 82,37 70,76 30,76 18,37" fill="#fff" stroke="var(--ink-black)" stroke-width="4"/>
        </svg>
        <div class="brand-text">
            <div class="app-title">DIB Jobs</div>
            <div class="app-subtitle">Defense Industrial Base Matcher</div>
        </div>
    </div>
</header>

<main>
    
    <div id="artiConsole" class="card arti-console">
        <div class="card-header" style="background: var(--card-white); border-bottom: 2px solid var(--ink-black);">
            <div class="brand">
                <img src="arti.png" alt="A" style="width:32px; height:32px;"> <span class="mono" style="font-weight:700; font-size:14px;">Arti // Career Coach</span>
            </div>
            <button onclick="clearAll()" class="mono" style="background:none; border:none; text-decoration:underline; font-size:11px; cursor:pointer;">Reset</button>
        </div>
        <div id="chatMessages" class="console-messages">
            </div>
        <div class="console-input-area">
            <input type="text" id="chatInput" class="console-input" placeholder="Ask Arti..." onkeypress="if(event.key==='Enter') sendChatMessage()">
            <button class="console-send" onclick="sendChatMessage()">-></button>
        </div>
    </div>

    <div id="inputSection" class="card">
        <div class="card-header">
            <span class="card-title">Analysis Data</span>
            <div class="resume-controls">
                <select id="resumeSelector" onchange="loadSavedResume()" style="padding:4px; font-family:Space Mono; border:2px solid var(--ink-black); border-radius:4px;">
                    <option value="">-- Saved Resumes --</option>
                </select>
                <button onclick="saveCurrentResume()" style="padding:4px 8px; font-family:Space Mono; border:2px solid var(--ink-black); background:white; cursor:pointer; border-radius:4px;">Save</button>
            </div>
        </div>
        <div class="card-body" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div>
                <div class="section-label">Your Resume</div>
                <textarea id="resumeText" placeholder="Paste resume text here..."></textarea>
            </div>
            <div>
                <div class="section-label">Job Description</div>
                <textarea id="jobDescription" placeholder="Paste JD or URL..."></textarea>
            </div>
        </div>
        <div style="padding: 0 32px 32px 32px; display:flex; gap:12px;">
            <button id="analyzeBtn" class="btn btn-primary" style="flex:1;" onclick="analyzeJob()">Analyze Match</button>
            <button class="btn btn-secondary" onclick="loadSampleData()">Load Sample</button>
        </div>
    </div>

    <div id="analysisResults" style="display: none;">
        
        <div class="card" style="padding:0; overflow:hidden;">
            <div id="matchScoreContainer" class="hero-grid">
                </div>
        </div>

        <div class="card">
            <div class="card-header"><span class="card-title">Job Intelligence</span></div>
            <div class="card-body">
                <div class="intel-grid">
                    <div class="intel-panel">
                        <div class="intel-value" id="salaryRange">--</div>
                        <div class="section-label" style="opacity:0.6;">Est. Salary</div>
                    </div>
                    <div class="intel-panel">
                        <div class="intel-value" id="competitionLevel">--</div>
                        <div class="section-label" style="opacity:0.6;">Competition</div>
                    </div>
                    <div class="intel-panel">
                        <div class="intel-value" id="hiringTime">--</div>
                        <div class="section-label" style="opacity:0.6;">Time to Hire</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><span class="card-title">Strengths & Gaps</span></div>
            <div class="card-body">
                <ul id="analysisList" style="list-style:none; display:flex; flex-direction:column; gap:12px;"></ul>
            </div>
        </div>

        <div id="appKitCard" class="card collapsible-card collapsed">
            <div class="card-header collapsible-trigger" onclick="toggleCard('appKitCard')">
                <span class="card-title">Application Kit</span>
                <span class="mono toggle-icon" style="font-weight:700; font-size:18px;">+</span>
            </div>
            <div class="collapsible-content card-body">
                <div class="kit-section">
                    <div class="kit-section-title">Tailored Summary</div>
                    <div id="resumeOutput" style="background:#fafafa; padding:16px; border:1px dashed var(--ink-black); font-size:13px; white-space:pre-wrap;"></div>
                </div>
                <div class="kit-section">
                    <div class="kit-section-title">Intro Email</div>
                    <button class="btn btn-secondary" onclick="generateCoverLetter()" id="genEmailBtn" style="width:100%;">Generate Draft</button>
                    <div id="emailDisplay" style="display:none; margin-top:16px; background:#fff; padding:16px; border:1px solid #ddd; white-space:pre-wrap; font-size:13px;"></div>
                </div>
            </div>
        </div>
        
        <div id="interviewKitCard" class="card collapsible-card collapsed">
            <div class="card-header collapsible-trigger" onclick="toggleCard('interviewKitCard')">
                <span class="card-title">Interview Prep</span>
                <span class="mono toggle-icon" style="font-weight:700; font-size:18px;">+</span>
            </div>
            <div class="collapsible-content card-body">
                <div id="interviewQuestionsList"></div>
            </div>
        </div>
        
        <div class="card" style="background:var(--accent-mint); text-align:center;">
            <div class="card-body" style="padding:20px;">
                <button class="btn btn-secondary" onclick="saveToTracker()">Save to Tracker</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <span class="card-title">My Applications</span>
        </div>
        <div class="card-body">
            <div id="trackerEmpty" style="text-align:center; opacity:0.6; font-size:13px;">No jobs tracked yet.</div>
            <table class="tracker-table" id="trackerTable" style="display:none;">
                <thead><tr><th>Company</th><th>Role</th><th>Score</th><th>Status</th><th></th></tr></thead>
                <tbody id="trackerBody"></tbody>
            </table>
        </div>
    </div>

    <div class="card collapsible-card collapsed" id="linksCard">
        <div class="card-header collapsible-trigger" onclick="toggleCard('linksCard')">
            <span class="card-title">Job Search Links</span>
            <span class="mono toggle-icon">+</span>
        </div>
        <div class="collapsible-content card-body">
            <div style="display:flex; flex-wrap:wrap; gap:10px;">
                <a href="https://www.linkedin.com/company/lockheed-martin/jobs/" target="_blank" class="chip" style="text-decoration:none; color:black;">Lockheed Martin</a>
                <a href="https://www.linkedin.com/company/boeing/jobs/" target="_blank" class="chip" style="text-decoration:none; color:black;">Boeing</a>
                <a href="https://www.linkedin.com/company/northrop-grumman-corporation/jobs/" target="_blank" class="chip" style="text-decoration:none; color:black;">Northrop Grumman</a>
                <a href="https://www.clearancejobs.com" target="_blank" class="chip" style="text-decoration:none; color:black;">ClearanceJobs</a>
            </div>
        </div>
    </div>

</main>

<div id="errorToast" class="error-toast"></div>

<script>
// ==========================================================================
// CONFIG & STATE
// ==========================================================================
const API_ENDPOINT = 'https://76unm1rlj0.execute-api.us-east-1.amazonaws.com/default/grumpy2';
const RESUME_KEY = 'dib_jobs_resumes';
const TRACKER_KEY = 'dib_jobs_tracker';

let appState = {
    analysis: null,
    chatHistory: [],
    resumes: JSON.parse(localStorage.getItem(RESUME_KEY) || '{}'),
    tracker: JSON.parse(localStorage.getItem(TRACKER_KEY) || '[]')
};

// ==========================================================================
// INITIALIZATION
// ==========================================================================
document.addEventListener('DOMContentLoaded', () => {
    // 1. Initial Arti Greeting
    setTimeout(() => {
        addChatMessage('arti', "Welcome to DIB Jobs. I'm Arti, your career coach.");
        setTimeout(() => {
            addChatMessage('arti', "Paste your **Resume** and a **Job Description** below to get started.");
        }, 600);
    }, 500);

    updateResumeSelector();
    renderTracker();
});

// ==========================================================================
// CHAT CONSOLE LOGIC
// ==========================================================================
const chatContainer = document.getElementById('chatMessages');

function addChatMessage(sender, text, chips = []) {
    const div = document.createElement('div');
    div.className = `msg-row ${sender}`;
    
    // Formatting: Bold and Newlines
    let fmtText = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Avatar
    let avatarHtml = '';
    if (sender === 'arti') {
        avatarHtml = `<div class="msg-avatar"><img src="arti.png" alt="A"></div>`;
    }

    // Chips
    let chipsHtml = '';
    if (chips.length > 0) {
        chipsHtml = `<div class="chat-chips">
            ${chips.map(c => `<div class="chip" onclick="${c.action}">${c.label}</div>`).join('')}
        </div>`;
    }

    div.innerHTML = `
        ${avatarHtml}
        <div class="msg-bubble">
            <div>${fmtText}</div>
            ${chipsHtml}
        </div>
    `;
    
    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // Add to history for API context
    appState.chatHistory.push({role: sender === 'arti' ? 'assistant' : 'user', content: text});
}

function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if(!text) return;
    
    input.value = '';
    addChatMessage('user', text);
    
    // Show thinking
    const loadingId = 'loading_' + Date.now();
    addChatMessage('arti', `<span id="${loadingId}">Thinking...</span>`);
    
    // Call API
    fetch(API_ENDPOINT, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            request_type: 'ask_expert',
            question: text,
            job_description: document.getElementById('jobDescription').value,
            resume_text: document.getElementById('resumeText').value,
            analysis_data: appState.analysis,
            chat_history: appState.chatHistory.slice(-6) // Limit context
        })
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById(loadingId).closest('.msg-row').remove();
        if(data.error) throw new Error(data.error);
        addChatMessage('arti', data.response);
    })
    .catch(e => {
        document.getElementById(loadingId).closest('.msg-row').remove();
        addChatMessage('arti', "Sorry, I couldn't process that. Did you analyze a job yet?");
    });
}

// ==========================================================================
// ANALYSIS LOGIC
// ==========================================================================
function analyzeJob() {
    const resume = document.getElementById('resumeText').value.trim();
    const jd = document.getElementById('jobDescription').value.trim();
    
    if(!resume || !jd) {
        addChatMessage('arti', "I need both a Resume and a Job Description to proceed.");
        return;
    }
    
    const btn = document.getElementById('analyzeBtn');
    btn.disabled = true;
    btn.textContent = "Analyzing...";
    
    addChatMessage('arti', "Analyzing your fit...");
    
    fetch(API_ENDPOINT, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            request_type: 'resume_match',
            job_description: jd,
            resume_text: resume
        })
    })
    .then(r => r.json())
    .then(data => {
        if(data.error) throw new Error(data.error);
        appState.analysis = data;
        renderDashboard(data);
        
        // Arti Speaks!
        const score = data.score;
        let msg = `I've analyzed the role. You're a **${score}% Match**.`;
        if(score > 80) msg += " This looks like a great fit.";
        else if(score > 60) msg += " Good potential, but check the gaps below.";
        else msg += " It's a stretch role, but we can strategize.";
        
        msg += " What's next?";
        
        addChatMessage('arti', msg, [
            {label: "Draft Email", action: "triggerEmailGen()"},
            {label: "Prep Interview", action: "document.getElementById('interviewKitCard').scrollIntoView({behavior:'smooth'}); toggleCard('interviewKitCard', true)"},
            {label: "Fix Gaps", action: "document.getElementById('analysisList').scrollIntoView({behavior:'smooth'})"}
        ]);
        
        // Fetch Market Intel silently
        fetchMarketIntel(jd, data.job_title, data.company);
        
    })
    .catch(e => {
        showToast(e.message);
        addChatMessage('arti', "Analysis failed. Please try again.");
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = "Analyze Match";
    });
}

function renderDashboard(data) {
    document.getElementById('analysisResults').style.display = 'block';
    document.getElementById('analysisResults').scrollIntoView({behavior:'smooth'});
    
    // Score
    const theme = data.score >= 80 ? 'var(--accent-olive)' : data.score >= 60 ? 'var(--accent-gold)' : 'var(--accent-clay)';
    const textColor = data.score >= 60 && data.score < 80 ? 'var(--ink-black)' : 'white';
    
    document.getElementById('matchScoreContainer').innerHTML = `
        <div class="score-box" style="background:${theme}; color:${textColor}">
            <div class="score-val">${data.score}%</div>
            <div class="score-label">Match Score</div>
        </div>
        <div class="verdict-box">
            <h3 style="margin-bottom:8px;">${data.verdict || 'Analysis Complete'}</h3>
            <p style="opacity:0.7; font-size:14px;">
                <strong>Role:</strong> ${data.job_title || '--'}<br>
                <strong>Company:</strong> ${data.company || '--'}
            </p>
        </div>
    `;

    // Gaps/Strengths
    const list = document.getElementById('analysisList');
    list.innerHTML = '';
    data.analysis.forEach(item => {
        const isGap = item.startsWith('Gap') || item.startsWith('Risk');
        const li = document.createElement('li');
        li.style.border = '2px solid var(--ink-black)';
        li.style.padding = '12px';
        li.style.borderRadius = '6px';
        li.style.background = '#fff';
        li.style.borderLeft = isGap ? '6px solid var(--accent-clay)' : '6px solid var(--accent-olive)';
        li.innerHTML = `<strong>${isGap ? 'Gap / Risk' : 'Strength'}</strong> ${item.replace(/^(Match:|Gap:|Risk:)/, '')}`;
        list.appendChild(li);
    });

    // Kits
    document.getElementById('resumeOutput').textContent = data.tailored_summary;
    document.getElementById('interviewQuestionsList').innerHTML = (data.interview_questions || []).map((q, i) => `
        <div style="background:#fff; border:2px solid var(--ink-black); margin-bottom:12px; border-radius:6px; overflow:hidden;">
            <div style="background:var(--accent-mint); padding:10px; font-weight:700; font-size:13px; border-bottom:2px solid var(--ink-black);">Q${i+1}: ${q.question}</div>
            <div style="padding:16px; font-size:14px;">${q.suggested_answer}</div>
        </div>
    `).join('');
}

// ==========================================================================
// INTEL & HELPERS
// ==========================================================================
function fetchMarketIntel(jd, title, company) {
    fetch(API_ENDPOINT, {
        method: 'POST',
        body: JSON.stringify({request_type: 'market_intel', job_description: jd, job_title: title, company: company})
    })
    .then(r => r.json())
    .then(data => {
        if(data.salary_intel) document.getElementById('salaryRange').textContent = `$${data.salary_intel.mid}K`;
        if(data.competition) document.getElementById('competitionLevel').textContent = data.competition.level;
        if(data.timeline) document.getElementById('hiringTime').textContent = data.timeline.offer_weeks + " wks";
    });
}

function triggerEmailGen() {
    toggleCard('appKitCard', true);
    document.getElementById('appKitCard').scrollIntoView({behavior:'smooth'});
    generateCoverLetter();
}

function generateCoverLetter() {
    const btn = document.getElementById('genEmailBtn');
    btn.textContent = "Generating...";
    fetch(API_ENDPOINT, {
        method: 'POST',
        body: JSON.stringify({
            request_type: 'generate_intro_email',
            job_description: document.getElementById('jobDescription').value,
            resume_text: document.getElementById('resumeText').value,
            analysis_data: appState.analysis
        })
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('emailDisplay').style.display = 'block';
        document.getElementById('emailDisplay').textContent = data.intro_email;
    })
    .finally(() => btn.textContent = "Generate Draft");
}

// ==========================================================================
// UTILITY FUNCTIONS
// ==========================================================================
function toggleCard(id, forceOpen = false) {
    const card = document.getElementById(id);
    if(forceOpen) card.classList.remove('collapsed');
    else card.classList.toggle('collapsed');
}

function saveCurrentResume() {
    const text = document.getElementById('resumeText').value;
    if(text.length < 50) return showToast("Resume too short");
    const name = prompt("Name this resume:");
    if(name) {
        appState.resumes[name] = {text: text, date: new Date().toISOString()};
        localStorage.setItem(RESUME_KEY, JSON.stringify(appState.resumes));
        updateResumeSelector();
        showToast("Resume saved!");
    }
}

function updateResumeSelector() {
    const sel = document.getElementById('resumeSelector');
    sel.innerHTML = '<option value="">-- Saved Resumes --</option>';
    Object.keys(appState.resumes).forEach(k => {
        sel.innerHTML += `<option value="${k}">${k}</option>`;
    });
}

function loadSavedResume() {
    const name = document.getElementById('resumeSelector').value;
    if(name && appState.resumes[name]) {
        document.getElementById('resumeText').value = appState.resumes[name].text;
    }
}

function loadSampleData() {
    document.getElementById('resumeText').value = "EXPERIENCED FEDERAL SALES DIRECTOR...";
    document.getElementById('jobDescription').value = "Principal DoD Sales Representative...";
    showToast("Sample data loaded");
}

function saveToTracker() {
    if(!appState.analysis) return;
    const job = {
        id: Date.now(),
        company: appState.analysis.company,
        role: appState.analysis.job_title,
        score: appState.analysis.score,
        status: 'Saved',
        date: new Date().toLocaleDateString()
    };
    appState.tracker.unshift(job);
    localStorage.setItem(TRACKER_KEY, JSON.stringify(appState.tracker));
    renderTracker();
    showToast("Saved to Tracker");
}

function renderTracker() {
    const tb = document.getElementById('trackerBody');
    if(appState.tracker.length === 0) {
        document.getElementById('trackerEmpty').style.display = 'block';
        document.getElementById('trackerTable').style.display = 'none';
        return;
    }
    document.getElementById('trackerEmpty').style.display = 'none';
    document.getElementById('trackerTable').style.display = 'table';
    tb.innerHTML = appState.tracker.map(t => `
        <tr>
            <td><b>${t.company}</b></td>
            <td>${t.role}</td>
            <td>${t.score}%</td>
            <td>${t.status}</td>
            <td><button onclick="deleteJob(${t.id})">x</button></td>
        </tr>
    `).join('');
}

function deleteJob(id) {
    appState.tracker = appState.tracker.filter(t => t.id !== id);
    localStorage.setItem(TRACKER_KEY, JSON.stringify(appState.tracker));
    renderTracker();
}

function showToast(msg) {
    const t = document.getElementById('errorToast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

function clearAll() {
    document.getElementById('resumeText').value = '';
    document.getElementById('jobDescription').value = '';
    document.getElementById('analysisResults').style.display = 'none';
    addChatMessage('arti', "Reset complete. Ready for new input.");
}
</script>
</body>
</html>