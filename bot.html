<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DIB Jobs // Defense Industrial Base Jobs</title>
    <meta name="description" content="A job matching and application toolkit built for Defense Industrial Base professionals.">
    <link rel="canonical" href="https://dibjobs.com/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="DIB Jobs - Defense Industrial Base Job Matcher">
    <meta property="og:description" content="A job matching and application toolkit for Defense Industrial Base professionals.">
    <meta property="og:url" content="https://dibjobs.com/">
    <meta property="og:image" content="https://dibjobs.com/dibjobs.png">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* ==========================================================================
   DIB JOBS - CHUNKY NEO-BRUTALIST STYLE
   ========================================================================== */

:root {
    /* Colors */
    --ink-black: #1a1a2e;
    --deep-blue: #4a6a8a;
    --soft-blue: #93b5d9;
    --pale-blue: #c8dae8;
    --warm-cream: #f8f6f1;
    --card-white: #ffffff;
    --bg-blue: #e8f0f6;
    --accent-clay: #e07a5f;
    --accent-gold: #f2cc8f;
    --accent-olive: #81b29a;
    --accent-mint: #d4e8dc;
    
    /* Chunky tokens */
    --border: 3px solid var(--ink-black);
    --radius: 16px;
    --radius-sm: 10px;
    --radius-pill: 50px;
    --shadow: 6px 6px 0 var(--ink-black);
    --shadow-sm: 4px 4px 0 var(--ink-black);
    --shadow-soft: 6px 6px 0 rgba(0,0,0,0.08);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Inter', -apple-system, sans-serif;
    background: var(--bg-blue);
    color: var(--ink-black);
    line-height: 1.6;
    min-height: 100vh;
}

h1, h2, h3, .mono { font-family: 'Space Mono', monospace; }

/* HEADER */
header {
    background: var(--card-white);
    border-bottom: var(--border);
    padding: 14px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
}

.logo { display: flex; align-items: center; gap: 12px; }
.logo svg { width: 42px; height: 42px; }
.logo h1 { font-size: 22px; font-weight: 700; }

.tagline {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 1px;
    background: var(--ink-black);
    color: white;
    padding: 6px 14px;
    border-radius: var(--radius-pill);
}

/* MAIN */
main {
    max-width: 1100px;
    margin: 0 auto;
    padding: 32px 24px;
}

/* CARDS - CHUNKY */
.card {
    background: var(--card-white);
    border: var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    margin-bottom: 24px;
    overflow: hidden;
}

.card-header {
    padding: 14px 20px;
    border-bottom: var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--warm-cream);
}

.card-title {
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.card-title::before {
    content: '';
    width: 10px;
    height: 10px;
    background: var(--ink-black);
    border-radius: 50%;
}

.card-title.has-avatar::before { display: none; }

.card-meta {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    opacity: 0.65;
}

.card-body { padding: 24px; }

/* BUTTONS - CHUNKY */
.btn {
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    padding: 14px 24px;
    border: var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: transform 0.1s, box-shadow 0.1s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.btn:hover:not(:disabled) {
    transform: translate(-2px, -2px);
    box-shadow: 8px 8px 0 var(--ink-black);
}

.btn:active:not(:disabled) {
    transform: translate(2px, 2px);
    box-shadow: 2px 2px 0 var(--ink-black);
}

.btn-primary {
    background: var(--deep-blue);
    color: white;
    box-shadow: var(--shadow);
}

.btn-secondary {
    background: var(--card-white);
    color: var(--ink-black);
    box-shadow: var(--shadow-sm);
}

.btn-small {
    padding: 8px 16px;
    font-size: 11px;
    border-radius: 8px;
    box-shadow: var(--shadow-sm);
}

.btn-large {
    padding: 18px 36px;
    font-size: 15px;
}

.btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* INPUTS */
textarea, input[type="text"] {
    width: 100%;
    padding: 16px;
    font-size: 14px;
    font-family: inherit;
    border: var(--border);
    border-radius: var(--radius-sm);
    background: var(--card-white);
    resize: vertical;
}

textarea:focus, input[type="text"]:focus {
    outline: none;
    box-shadow: var(--shadow-sm);
}

textarea { min-height: 160px; }

/* COLLAPSIBLE */
.collapsible-card.collapsed .collapsible-content { display: none; }
.collapsible-trigger { cursor: pointer; }
.collapsible-trigger:hover { background: var(--bg-blue); }
.collapsible-content { border-top: var(--border); }

.toggle-icon {
    font-family: 'Space Mono', monospace;
    font-weight: 700;
    font-size: 18px;
    width: 28px;
    height: 28px;
    display: grid;
    place-items: center;
    background: var(--ink-black);
    color: white;
    border-radius: 6px;
}

/* ==========================================================================
   ARTI WELCOME
   ========================================================================== */
.arti-welcome {
    display: flex;
    align-items: center;
    gap: 24px;
    padding: 28px 32px;
    margin-bottom: 28px;
    background: var(--card-white);
    border: var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
}

.arti-avatar-large {
    width: 72px;
    height: 72px;
    border-radius: var(--radius-sm);
    flex-shrink: 0;
}

.arti-welcome-text h1 {
    font-size: 26px;
    margin-bottom: 6px;
}

.arti-welcome-text p {
    font-size: 14px;
    line-height: 1.5;
    opacity: 0.8;
}

/* ==========================================================================
   INPUT SECTION
   ========================================================================== */
.input-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
}

.input-card {
    background: var(--card-white);
    border: var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
}

.input-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: var(--pale-blue);
    border-bottom: var(--border);
}

.input-label {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
}

.input-card textarea {
    border: none;
    border-radius: 0;
    box-shadow: none;
    min-height: 180px;
}

.resume-controls { display: flex; gap: 8px; align-items: center; }
.resume-controls select {
    padding: 6px 10px;
    font-size: 11px;
    border: 2px solid var(--ink-black);
    border-radius: 6px;
}

.analyze-section {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 32px;
    flex-wrap: wrap;
}

.btn-avatar {
    width: 24px;
    height: 24px;
    border-radius: 6px;
}

/* ==========================================================================
   SCORE HERO - CHUNKY
   ========================================================================== */
.score-hero {
    padding: 0 !important;
    margin-bottom: 24px;
    display: grid;
    grid-template-columns: 200px 1fr;
}

.score-block {
    background: var(--ink-black);
    color: white;
    padding: 40px 20px;
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.score-num {
    font-family: 'Space Mono', monospace;
    font-size: 72px;
    font-weight: 700;
    line-height: 1;
}

.score-pct {
    font-family: 'Space Mono', monospace;
    font-size: 28px;
    font-weight: 700;
}

.score-word {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    letter-spacing: 2px;
    opacity: 0.6;
    margin-top: 10px;
}

.score-hero.score-high .score-block { background: var(--accent-olive); }
.score-hero.score-mid .score-block { background: var(--accent-gold); color: var(--ink-black); }
.score-hero.score-low .score-block { background: var(--accent-clay); }

.score-meta {
    padding: 28px 32px;
    background: var(--warm-cream);
    display: flex;
    flex-direction: column;
    justify-content: center;
    border-left: var(--border);
}

.score-meta h2 {
    font-size: 18px;
    margin-bottom: 12px;
    color: var(--accent-olive);
}

.score-meta p {
    font-size: 13px;
    margin-bottom: 4px;
}

.score-meta strong {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    text-transform: uppercase;
}

/* ==========================================================================
   DASHBOARD GRID - BI STYLE
   ========================================================================== */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 24px;
}

.dash-card {
    background: var(--card-white);
    border: var(--border);
    border-radius: var(--radius);
    padding: 20px;
    text-align: center;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
}

.dash-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: var(--deep-blue);
}

.dash-card:nth-child(1)::before { background: var(--accent-olive); }
.dash-card:nth-child(2)::before { background: var(--accent-clay); }
.dash-card:nth-child(3)::before { background: var(--deep-blue); }
.dash-card:nth-child(4)::before { background: var(--accent-gold); }
.dash-card:nth-child(5)::before { background: var(--soft-blue); }
.dash-card:nth-child(6)::before { background: var(--pale-blue); }

.dash-card-label {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.5;
    margin-bottom: 8px;
}

.dash-card-value {
    font-family: 'Space Mono', monospace;
    font-size: 32px;
    font-weight: 700;
    color: var(--ink-black);
    line-height: 1.1;
}

.dash-card-sub {
    font-size: 11px;
    opacity: 0.5;
    margin-top: 6px;
}

/* ==========================================================================
   ARTI TAKE - SPEECH BUBBLE
   ========================================================================== */
.arti-take {
    display: flex;
    gap: 16px;
    align-items: flex-start;
    margin-bottom: 24px;
}

.arti-avatar {
    width: 52px;
    height: 52px;
    border-radius: var(--radius-sm);
    flex-shrink: 0;
}

.arti-avatar-small {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-sm);
    flex-shrink: 0;
}

.header-avatar {
    width: 28px;
    height: 28px;
    border-radius: 6px;
}

.arti-bubble {
    flex: 1;
    background: var(--accent-mint);
    border: var(--border);
    border-radius: var(--radius);
    padding: 18px 22px;
    font-size: 14px;
    line-height: 1.6;
    box-shadow: var(--shadow);
    position: relative;
}

.arti-bubble::before {
    content: '';
    position: absolute;
    left: -14px;
    top: 18px;
    width: 0;
    height: 0;
    border: 8px solid transparent;
    border-right-color: var(--ink-black);
}

.arti-bubble::after {
    content: '';
    position: absolute;
    left: -8px;
    top: 21px;
    width: 0;
    height: 0;
    border: 5px solid transparent;
    border-right-color: var(--accent-mint);
}

/* ==========================================================================
   TWO COLUMN LAYOUT
   ========================================================================== */
.two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
}

.header-match { background: rgba(129, 178, 154, 0.25) !important; }
.header-gap { background: rgba(224, 122, 95, 0.25) !important; }

.fit-list { list-style: none; }

.fit-list li {
    padding: 14px 18px;
    margin-bottom: 12px;
    background: var(--card-white);
    border: var(--border);
    border-radius: var(--radius-sm);
    font-size: 13px;
    line-height: 1.5;
    box-shadow: var(--shadow-sm);
}

.fit-list li:last-child { margin-bottom: 0; }

.fit-list.matches li { border-left: 8px solid var(--accent-olive); }
.fit-list.gaps li { border-left: 8px solid var(--accent-clay); }

.fit-list li strong {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    text-transform: uppercase;
    display: block;
    margin-bottom: 4px;
}

.fit-list.matches li strong { color: var(--accent-olive); }
.fit-list.gaps li strong { color: var(--accent-clay); }

/* ==========================================================================
   KEYWORDS
   ========================================================================== */
.keyword-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.keyword-tag {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    font-weight: 600;
    padding: 8px 16px;
    border-radius: var(--radius-pill);
    border: 2px solid var(--ink-black);
}

.keyword-tag.in-resume {
    background: var(--accent-mint);
    border-color: var(--accent-olive);
}

.keyword-tag.missing {
    background: rgba(224, 122, 95, 0.2);
    border-color: var(--accent-clay);
    color: #a5635a;
}

/* ==========================================================================
   CHAT
   ========================================================================== */
.chat-thread {
    max-height: 400px;
    overflow-y: auto;
    margin-bottom: 16px;
}

.chat-thread .arti-take { margin-bottom: 16px; }

.user-message {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 16px;
}

.user-bubble {
    background: var(--ink-black);
    color: white;
    border-radius: var(--radius);
    padding: 14px 18px;
    font-size: 14px;
    max-width: 80%;
}

.chat-suggestions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 16px;
}

.suggestion-btn {
    padding: 10px 16px;
    font-size: 12px;
    font-family: 'Space Mono', monospace;
    font-weight: 600;
    background: var(--warm-cream);
    border: 2px solid var(--ink-black);
    border-radius: var(--radius-pill);
    cursor: pointer;
    transition: all 0.1s;
}

.suggestion-btn:hover {
    background: var(--ink-black);
    color: white;
}

.chat-input-row {
    display: flex;
    gap: 12px;
}

.chat-input-row input {
    flex: 1;
    padding: 16px 18px;
    font-size: 14px;
}

/* ==========================================================================
   KIT SECTIONS
   ========================================================================== */
.kit-section { margin-bottom: 24px; }
.kit-section:last-child { margin-bottom: 0; }

.kit-section-title {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px dashed rgba(0,0,0,0.15);
}

.kit-divider {
    border: none;
    border-top: 2px dashed rgba(0,0,0,0.1);
    margin: 24px 0;
}

.resume-paper {
    background: var(--warm-cream);
    border: 2px solid var(--ink-black);
    border-radius: var(--radius-sm);
    padding: 20px;
    font-size: 14px;
    line-height: 1.7;
}

.email-output {
    display: none;
    white-space: pre-wrap;
    font-size: 14px;
    line-height: 1.6;
    background: var(--warm-cream);
    padding: 20px;
    border: 2px solid var(--ink-black);
    border-radius: var(--radius-sm);
}

.qa-card {
    background: var(--warm-cream);
    border: 2px solid var(--ink-black);
    border-radius: var(--radius-sm);
    margin-bottom: 16px;
    overflow: hidden;
}

.qa-q {
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    font-weight: 700;
    padding: 14px 18px;
    background: var(--pale-blue);
    border-bottom: 2px solid var(--ink-black);
}

.qa-a {
    padding: 14px 18px;
    font-size: 13px;
    line-height: 1.6;
}

.network-links {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.network-link {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    font-weight: 600;
    padding: 10px 18px;
    background: var(--card-white);
    border: 2px solid var(--ink-black);
    border-radius: var(--radius-pill);
    text-decoration: none;
    color: var(--ink-black);
    transition: all 0.1s;
}

.network-link:hover {
    background: var(--ink-black);
    color: white;
}

/* ==========================================================================
   SAVE PROMPT
   ========================================================================== */
.save-prompt {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    padding: 18px;
    background: var(--warm-cream);
    border: 3px dashed var(--ink-black);
    border-radius: var(--radius);
    margin-bottom: 24px;
    font-size: 14px;
}

/* ==========================================================================
   TRACKER
   ========================================================================== */
.tracker-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.tracker-table th {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    text-transform: uppercase;
    text-align: left;
    padding: 12px 16px;
    background: var(--pale-blue);
    border-bottom: var(--border);
}

.tracker-table td {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.tracker-btn {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    font-weight: 700;
    padding: 6px 12px;
    background: var(--card-white);
    border: 2px solid var(--ink-black);
    border-radius: 6px;
    cursor: pointer;
    margin-right: 6px;
}

.tracker-btn:hover {
    background: var(--ink-black);
    color: white;
}

/* ==========================================================================
   LOADING & ERRORS
   ========================================================================== */
.inline-error {
    display: none;
    margin-top: 16px;
    padding: 14px 18px;
    background: rgba(224, 122, 95, 0.15);
    border: 2px solid var(--accent-clay);
    border-radius: var(--radius-sm);
    color: #a5635a;
    font-size: 13px;
}

.inline-error.visible { display: block; }

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ==========================================================================
   RESPONSIVE
   ========================================================================== */
@media (max-width: 900px) {
    .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 768px) {
    .arti-welcome {
        flex-direction: column;
        text-align: center;
        padding: 24px;
    }
    .arti-welcome-text h1 { font-size: 22px; }
    .input-section { grid-template-columns: 1fr; }
    .score-hero { grid-template-columns: 1fr; }
    .score-block { padding: 28px; }
    .score-num { font-size: 56px; }
    .score-meta { border-left: none; border-top: var(--border); }
    .dashboard-grid { grid-template-columns: 1fr 1fr; }
    .two-col { grid-template-columns: 1fr; }
    .analyze-section { flex-direction: column; }
    .analyze-section .btn { width: 100%; }
}

@media (max-width: 500px) {
    .dashboard-grid { grid-template-columns: 1fr; }
    main { padding: 20px 16px; }
}
</style>
</head>
<body>

<header>
    <div class="brand">
        <img src="arti.png" alt="DIB Jobs" class="logo-icon">
        <div class="brand-text">
            <span class="app-title">DIB Jobs</span>
            <span class="app-subtitle">Defense Industrial Base Job Matcher</span>
        </div>
    </div>
</header>

<main>
    <!-- ARTI WELCOME -->
    <div class="arti-welcome">
        <img src="arti.png" alt="Arti" class="arti-avatar-large">
        <div class="arti-welcome-text">
            <h1>Let's get you hired.</h1>
            <p>I'm Arti, your DIB career coach. Paste your resume and a job description below, and I'll show you exactly where you stand and how to win.</p>
        </div>
    </div>

    <!-- INPUT SECTION -->
    <div class="input-section">
        <div class="input-card">
            <div class="input-header">
                <span class="input-label">Your Resume</span>
                <div class="resume-controls">
                    <select id="resumeSelector" onchange="loadSavedResume()">
                        <option value="">-- Saved --</option>
                    </select>
                    <button class="btn-small" onclick="saveCurrentResume()">Save</button>
                </div>
            </div>
            <textarea id="resumeText" placeholder="Paste your resume text here..."></textarea>
        </div>
        <div class="input-card">
            <div class="input-header">
                <span class="input-label">Job Description</span>
            </div>
            <textarea id="jobDescription" placeholder="Paste the job description or URL..."></textarea>
        </div>
    </div>

    <div class="analyze-section">
        <button id="analyzeBtn" class="btn btn-primary btn-large" onclick="analyzeJob()">
            <img src="arti.png" alt="" class="btn-avatar">
            <span id="btnText">Analyze My Fit</span>
        </button>
        <button class="btn btn-secondary" onclick="loadSampleData()">Try Sample Data</button>
        <div id="inlineError" class="inline-error"><span id="inlineErrorText"></span></div>
    </div>

    <!-- LOADING -->
    <div id="loadingCard" class="card" style="display:none; text-align:center; padding: 48px 24px; background: var(--bg-cream); border: 2px dashed var(--ink-black);">
        <img src="arti.png" alt="Arti" style="width: 64px; height: 64px; border-radius: var(--radius); margin-bottom: 16px;">
        <h2 id="loadingStep" style="font-size: 16px; text-transform: uppercase; margin-bottom: 16px;">Reading the job posting...</h2>
        <div style="max-width: 400px; margin: 0 auto; border: 2px solid var(--ink-black); height: 24px; border-radius: 12px; background: #fff; overflow: hidden;">
            <div id="loadingProgress" style="width: 5%; height: 100%; background: var(--accent-mint); border-right: 2px solid var(--ink-black); transition: width 0.3s;"></div>
        </div>
    </div>

    <!-- RESULTS -->
    <div id="analysisResults" style="display: none;">

        <!-- SCORE HERO -->
        <div class="card score-hero" id="scoreHero">
            <div class="score-block" id="scoreBlock">
                <span class="score-num" id="scoreValue">--</span><span class="score-pct">%</span>
                <span class="score-word">MATCH SCORE</span>
            </div>
            <div class="score-meta">
                <h2 id="jobVerdict">Analyzing...</h2>
                <p><strong>Role:</strong> <span id="jobTitle">--</span></p>
                <p><strong>Company:</strong> <span id="jobCompany">--</span></p>
            </div>
        </div>

        <!-- DASHBOARD GRID - 3x3 BI Style -->
        <div class="dashboard-grid">
            <div class="dash-card">
                <div class="dash-card-label">Strengths</div>
                <div class="dash-card-value" id="matchCount">0</div>
                <div class="dash-card-sub">alignment points</div>
            </div>
            <div class="dash-card">
                <div class="dash-card-label">Gaps</div>
                <div class="dash-card-value" id="gapCount">0</div>
                <div class="dash-card-sub">to address</div>
            </div>
            <div class="dash-card">
                <div class="dash-card-label">Keywords</div>
                <div class="dash-card-value" id="keywordHitRate">--%</div>
                <div class="dash-card-sub"><span id="kwMatched">0</span> of <span id="kwTotal">0</span> matched</div>
            </div>
            <div class="dash-card">
                <div class="dash-card-label">Salary Estimate</div>
                <div class="dash-card-value" id="salaryQuick">--</div>
                <div class="dash-card-sub" id="salaryRange">Loading...</div>
            </div>
            <div class="dash-card">
                <div class="dash-card-label">Competition</div>
                <div class="dash-card-value" id="competitionLevel">--</div>
                <div class="dash-card-sub" id="competitionDesc">Analyzing...</div>
            </div>
            <div class="dash-card">
                <div class="dash-card-label">Time to Offer</div>
                <div class="dash-card-value" id="offerDays">--</div>
                <div class="dash-card-sub">estimated timeline</div>
            </div>
        </div>

        <!-- ARTI'S TAKE -->
        <div class="arti-take">
            <img src="arti.png" alt="Arti" class="arti-avatar">
            <div class="arti-bubble">
                <p id="coachTake">Analyzing your fit...</p>
            </div>
        </div>

        <!-- KEYWORDS -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">Keywords</span>
                <span class="card-meta"><span id="kwMatchedAlt">0</span> matched, <span id="kwMissing">0</span> missing</span>
            </div>
            <div class="card-body">
                <div class="keyword-cloud" id="dashboardKeywords"></div>
            </div>
        </div>

        <!-- STRENGTHS & GAPS -->
        <div class="two-col">
            <div class="card">
                <div class="card-header header-match"><span class="card-title">Your Strengths</span></div>
                <div class="card-body"><ul id="topMatches" class="fit-list matches"></ul></div>
            </div>
            <div class="card">
                <div class="card-header header-gap"><span class="card-title">Gaps to Address</span></div>
                <div class="card-body"><ul id="topGaps" class="fit-list gaps"></ul></div>
            </div>
        </div>

        <!-- ASK ARTI -->
        <div class="card" id="chatSection">
            <div class="card-header">
                <span class="card-title has-avatar">
                    <img src="arti.png" alt="Arti" class="header-avatar">
                    Ask Arti
                </span>
            </div>
            <div class="card-body">
                <div class="chat-thread" id="chatMessages">
                    <div class="arti-take" style="margin-bottom: 0;">
                        <img src="arti.png" alt="Arti" class="arti-avatar-small">
                        <div class="arti-bubble" id="initialChatMessage">What would you like to know? I can help with salary negotiation, addressing gaps, interview prep, or whether this role is worth pursuing.</div>
                    </div>
                </div>
                <div class="chat-suggestions" id="chatSuggestions">
                    <button class="suggestion-btn" onclick="askSuggestion('What salary should I ask for?')">Salary advice</button>
                    <button class="suggestion-btn" onclick="askSuggestion('How do I address my biggest gap?')">Address my gaps</button>
                    <button class="suggestion-btn" onclick="askSuggestion('Is this role worth pursuing?')">Worth pursuing?</button>
                    <button class="suggestion-btn" onclick="askSuggestion('What questions will they ask me?')">Interview Qs</button>
                </div>
                <div class="chat-input-row">
                    <input type="text" id="chatInput" placeholder="Ask me anything about this role..." onkeypress="if(event.key==='Enter')sendChatMessage()">
                    <button class="btn btn-primary" onclick="sendChatMessage()">Ask</button>
                </div>
            </div>
        </div>

        <!-- TOOLKIT -->
        <div class="card collapsible-card collapsed" id="toolkitCard">
            <div class="card-header collapsible-trigger" onclick="toggleKit('toolkit')">
                <span class="card-title">Application Toolkit</span>
                <span id="toolkitToggle" class="toggle-icon">+</span>
            </div>
            <div id="toolkitContent" class="collapsible-content">
                <div class="card-body">
                    <div class="kit-section">
                        <h4 class="kit-section-title">Tailored Executive Summary</h4>
                        <div id="resumeOutput" class="resume-paper"></div>
                        <button class="btn btn-secondary btn-small" onclick="copyResume()">Copy</button>
                    </div>
                    <hr class="kit-divider">
                    <div class="kit-section">
                        <h4 class="kit-section-title">Intro Email</h4>
                        <div id="coverLetterPlaceholder">
                            <button class="btn btn-primary" onclick="generateCoverLetter()" id="generateCoverLetterBtn">Generate Intro Email</button>
                        </div>
                        <div id="coverLetterDisplay" class="email-output"></div>
                        <button id="copyCLBtn" class="btn btn-secondary btn-small" onclick="copyCoverLetter()" style="display:none;">Copy</button>
                    </div>
                    <hr class="kit-divider">
                    <div class="kit-section">
                        <h4 class="kit-section-title">Interview Questions</h4>
                        <div id="interviewQuestionsList"></div>
                    </div>
                    <hr class="kit-divider">
                    <div class="kit-section">
                        <h4 class="kit-section-title">Gap Strategies</h4>
                        <div id="gapStrategiesList"></div>
                    </div>
                    <hr class="kit-divider">
                    <div class="kit-section">
                        <h4 class="kit-section-title">Research <span id="networkCompany">This Company</span></h4>
                        <div class="network-links" id="networkLinks"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SAVE -->
        <div class="save-prompt">
            <span>Track this application?</span>
            <button class="btn btn-secondary btn-small" onclick="saveToTracker()" id="saveToTrackerBtn">Save to Tracker</button>
        </div>
    </div>

    <!-- TRACKER -->
    <div id="trackerSection" class="card" style="display: none;">
        <div class="card-header">
            <span class="card-title">Tracked Applications</span>
            <span id="trackerCount" class="card-meta">0 jobs</span>
        </div>
        <div class="card-body">
            <table class="tracker-table">
                <thead><tr><th>Company</th><th>Role</th><th>Score</th><th>Status</th><th></th></tr></thead>
                <tbody id="trackerBody"></tbody>
            </table>
        </div>
    </div>
</main>

<div id="errorToast" class="error-toast">
    <span id="errorToastText"></span>
    <button class="error-toast-close" onclick="hideErrorToast()">x</button>
</div>

<script>
// ==========================================================================
// DIB JOBS - APP.JS
// ==========================================================================

const API_ENDPOINT = 'https://76unm1rlj0.execute-api.us-east-1.amazonaws.com/default/grumpy2';
const MAX_RETRIES = 3;
const RETRY_DELAY_MS = 2000;
const RESUME_STORAGE_KEY = 'dib_jobs_resumes';
const TRACKER_STORAGE_KEY = 'dibJobsTracker';
const STATS_STORAGE_KEY = 'dibJobsStats';
const LAST_RESUME_KEY = 'dibJobsLastResume';

let analysisData = null;
let chatHistory = [];
let currentTemplate = 'applied';
let trackedJobs = [];
let careerStats = { jobsAnalyzed: 0, scores: [] };

// ==========================================================================
// INIT
// ==========================================================================
document.addEventListener('DOMContentLoaded', () => {
    initTracker();
    initStats();
    updateResumeSelector();
    loadLastUsedResume();
    updateStatsDisplay();
    checkWorkflowProgress();
    document.getElementById('resumeText').addEventListener('input', debounce(checkWorkflowProgress, 500));
});

function debounce(fn, wait) {
    let t;
    return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
}

// ==========================================================================
// API HELPER WITH RETRY
// ==========================================================================
async function fetchWithRetry(url, options, retries = MAX_RETRIES) {
    for (let attempt = 1; attempt <= retries; attempt++) {
        try {
            const response = await fetch(url, options);
            if (response.ok) return response;
            
            // Don't retry on client errors (4xx)
            if (response.status >= 400 && response.status < 500) {
                return response;
            }
            
            // Server error - retry
            if (attempt < retries) {
                console.log(`Attempt ${attempt} failed, retrying in ${RETRY_DELAY_MS}ms...`);
                await new Promise(r => setTimeout(r, RETRY_DELAY_MS));
            } else {
                return response;
            }
        } catch (error) {
            if (attempt < retries) {
                console.log(`Attempt ${attempt} failed with error, retrying in ${RETRY_DELAY_MS}ms...`);
                await new Promise(r => setTimeout(r, RETRY_DELAY_MS));
            } else {
                throw error;
            }
        }
    }
}

// ==========================================================================
// STATS
// ==========================================================================
function initStats() {
    const s = localStorage.getItem(STATS_STORAGE_KEY);
    if (s) try { careerStats = JSON.parse(s); } catch(e) {}
}

function saveStats() {
    localStorage.setItem(STATS_STORAGE_KEY, JSON.stringify(careerStats));
}

function updateStatsDisplay() {
    // Stats display removed from UI - function kept for compatibility
}

// ==========================================================================
// WORKFLOW
// ==========================================================================
function checkWorkflowProgress() {
    // No longer needed - workflow steps removed
}

// ==========================================================================
// COLLAPSIBLE
// ==========================================================================
function toggleKit(id) {
    const card = document.getElementById(id + 'Card') || document.getElementById(id);
    const toggle = document.getElementById(id + 'Toggle');
    if (card.classList.contains('collapsed')) {
        card.classList.remove('collapsed');
        if (toggle) toggle.textContent = '-';
    } else {
        card.classList.add('collapsed');
        if (toggle) toggle.textContent = '+';
    }
}

// ==========================================================================
// RESUME
// ==========================================================================
function updateResumeSelector() {
    const sel = document.getElementById('resumeSelector');
    if (!sel) return;
    let resumes = [];
    try {
        resumes = JSON.parse(localStorage.getItem(RESUME_STORAGE_KEY) || '[]');
        if (!Array.isArray(resumes)) resumes = [];
    } catch(e) {
        resumes = [];
    }
    sel.innerHTML = '<option value="">-- Saved --</option>';
    resumes.forEach((r, i) => {
        sel.innerHTML += `<option value="${i}">${r.name || 'Resume '+(i+1)}</option>`;
    });
}

function loadSavedResume() {
    const i = document.getElementById('resumeSelector').value;
    if (i === '') return;
    const resumes = JSON.parse(localStorage.getItem(RESUME_STORAGE_KEY) || '[]');
    if (resumes[i]) {
        document.getElementById('resumeText').value = resumes[i].text;
        localStorage.setItem(LAST_RESUME_KEY, i);
        checkWorkflowProgress();
    }
}

function loadLastUsedResume() {
    const i = localStorage.getItem(LAST_RESUME_KEY);
    if (i !== null) {
        const resumes = JSON.parse(localStorage.getItem(RESUME_STORAGE_KEY) || '[]');
        if (resumes[i]) {
            document.getElementById('resumeText').value = resumes[i].text;
            document.getElementById('resumeSelector').value = i;
            checkWorkflowProgress();
        }
    }
}

function saveCurrentResume() {
    const text = document.getElementById('resumeText').value.trim();
    if (!text) { showToast('Enter your resume first'); return; }
    const name = prompt('Name this resume:');
    if (!name) return;
    const resumes = JSON.parse(localStorage.getItem(RESUME_STORAGE_KEY) || '[]');
    resumes.push({ name, text, date: new Date().toISOString() });
    localStorage.setItem(RESUME_STORAGE_KEY, JSON.stringify(resumes));
    localStorage.setItem(LAST_RESUME_KEY, resumes.length - 1);
    updateResumeSelector();
    document.getElementById('resumeSelector').value = resumes.length - 1;
    showToast('Resume saved!');
}

function clearResume() {
    document.getElementById('resumeText').value = '';
    document.getElementById('resumeSelector').value = '';
    checkWorkflowProgress();
}

// ==========================================================================
// MAIN ANALYSIS
// ==========================================================================
async function analyzeJob() {
    const resumeText = document.getElementById('resumeText').value.trim();
    const jobDescription = document.getElementById('jobDescription').value.trim();
    
    if (!resumeText || resumeText.length < 100) {
        showInlineError('Please paste your resume first.');
        return;
    }
    if (!jobDescription || jobDescription.length < 50) {
        showInlineError('Please paste a job description.');
        return;
    }
    
    hideInlineError();
    document.getElementById('loadingCard').style.display = 'block';
    document.getElementById('analysisResults').style.display = 'none';
    document.getElementById('analyzeBtn').disabled = true;
    
    const steps = [
        { text: 'Reading job requirements...', progress: 15 },
        { text: 'Analyzing your experience...', progress: 35 },
        { text: 'Identifying matches and gaps...', progress: 55 },
        { text: 'Preparing coaching...', progress: 75 },
        { text: 'Almost there...', progress: 90 }
    ];
    
    let stepIndex = 0;
    const loadingInterval = setInterval(() => {
        if (stepIndex < steps.length) {
            document.getElementById('loadingStep').textContent = steps[stepIndex].text;
            document.getElementById('loadingProgress').style.width = steps[stepIndex].progress + '%';
            stepIndex++;
        }
    }, 1500);
    
    try {
        const response = await fetchWithRetry(API_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ request_type: 'resume_match', job_description: jobDescription, resume_text: resumeText })
        });
        
        clearInterval(loadingInterval);
        
        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || 'Analysis failed');
        }
        
        analysisData = await response.json();
        
        careerStats.jobsAnalyzed++;
        careerStats.scores.push(analysisData.score || 0);
        saveStats();
        updateStatsDisplay();
        
        renderResults(analysisData);
        fetchMarketIntel(jobDescription, analysisData.job_title, analysisData.company);
        
        document.getElementById('loadingCard').style.display = 'none';
        document.getElementById('analysisResults').style.display = 'block';
        
        chatHistory = [];
        document.getElementById('chatMessages').innerHTML = `
            <div class="chat-message coach">
                <div class="chat-message-avatar"><img src="arti.png" alt="" style="width:100%;height:100%;border-radius:var(--radius);"></div>
                <div class="chat-message-bubble">${getInitialChatMessage(analysisData.score)}</div>
            </div>`;
        document.getElementById('chatSuggestions').style.display = 'flex';
        
        document.getElementById('scoreDashboard').scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        clearInterval(loadingInterval);
        document.getElementById('loadingCard').style.display = 'none';
        showToast(error.message || 'Something went wrong.');
    } finally {
        document.getElementById('analyzeBtn').disabled = false;
    }
}

function getInitialChatMessage(score) {
    if (score >= 80) return "Strong match. You're well positioned for this role. What would you like to know?";
    if (score >= 65) return "Solid opportunity. You meet most requirements with a few gaps to address. How can I help?";
    if (score >= 50) return "This is a stretch, but achievable. Want to discuss strategy?";
    return "Tough fit based on your resume. Want to talk through whether it's worth pursuing?";
}

// ==========================================================================
// RENDER RESULTS
// ==========================================================================
function renderResults(data) {
    const score = data.score || 0;
    
    // Score hero
    const hero = document.getElementById('scoreHero');
    if (hero) {
        hero.classList.remove('score-high', 'score-mid', 'score-low');
        hero.classList.add(score >= 75 ? 'score-high' : score >= 50 ? 'score-mid' : 'score-low');
    }
    
    document.getElementById('scoreValue').textContent = score;
    document.getElementById('jobTitle').textContent = data.job_title || 'Role';
    document.getElementById('jobCompany').textContent = data.company || 'Company';
    document.getElementById('jobVerdict').textContent = data.verdict || 'Match Analysis Complete';
    
    // Parse matches and gaps
    const matches = (data.analysis || []).filter(a => a.startsWith('Match:'));
    const gaps = (data.analysis || []).filter(a => a.startsWith('Gap:'));
    
    // Dashboard metrics
    document.getElementById('matchCount').textContent = matches.length;
    document.getElementById('gapCount').textContent = gaps.length;
    
    // Keywords processing
    const keywords = data.keywords || [];
    const kwMatched = keywords.filter(kw => typeof kw === 'object' ? kw.in_resume : false).length;
    const kwMissing = keywords.length - kwMatched;
    const kwHitRate = keywords.length > 0 ? Math.round((kwMatched / keywords.length) * 100) : 0;
    
    document.getElementById('keywordHitRate').textContent = kwHitRate + '%';
    document.getElementById('kwMatched').textContent = kwMatched;
    document.getElementById('kwTotal').textContent = keywords.length;
    document.getElementById('kwMatchedAlt').textContent = kwMatched;
    document.getElementById('kwMissing').textContent = kwMissing;
    
    // Coach take
    let coachTake = '';
    if (score >= 80) {
        coachTake = "Strong fit. You hit most of their requirements. Focus on your wins in the interview and you should be competitive.";
    } else if (score >= 65) {
        coachTake = "Good opportunity with gaps to address. Check the missing keywords and prepare talking points for your gaps before applying.";
    } else if (score >= 50) {
        coachTake = "Stretch role. You'll need to work harder to stand out. Consider networking into this one and addressing gaps head-on in your cover letter.";
    } else {
        coachTake = "Significant gaps here. This role may require skills you're still building. Could be a target to work toward over time.";
    }
    document.getElementById('coachTake').textContent = coachTake;
    
    // Keywords display
    const dashKw = document.getElementById('dashboardKeywords');
    dashKw.innerHTML = keywords.map(kw => {
        const term = typeof kw === 'string' ? kw : (kw.term || kw.keyword || '');
        const inResume = typeof kw === 'object' ? kw.in_resume : false;
        return `<span class="keyword-tag ${inResume ? 'in-resume' : 'missing'}">${esc(term)}</span>`;
    }).join('');
    
    // Matches list
    document.getElementById('topMatches').innerHTML = matches.map(m => {
        const text = m.replace('Match:', '').trim();
        const parts = text.split(/→|--/);
        return `<li><strong>${esc(parts[0].trim())}</strong>${parts[1] ? esc(parts[1].trim()) : ''}</li>`;
    }).join('');
    
    // Gaps list
    document.getElementById('topGaps').innerHTML = gaps.map(g => {
        const text = g.replace('Gap:', '').trim();
        const parts = text.split(/→|--/);
        return `<li><strong>${esc(parts[0].trim())}</strong>${parts[1] ? esc(parts[1].trim()) : ''}</li>`;
    }).join('');
    
    // Resume output
    document.getElementById('resumeOutput').innerHTML = esc(data.tailored_summary || '').replace(/\n/g, '<br>');
    
    // Interview questions
    document.getElementById('interviewQuestionsList').innerHTML = (data.interview_questions || []).map(q => `
        <div class="qa-card">
            <div class="qa-q">${esc(q.question)}</div>
            <div class="qa-a">${esc(q.suggested_answer || q.answer || '')}</div>
        </div>
    `).join('');
    
    // Gap strategies
    document.getElementById('gapStrategiesList').innerHTML = (data.gap_strategies || []).map(s => `
        <div class="qa-card">
            <div class="qa-q">${esc(s.gap)}</div>
            <div class="qa-a">${esc(s.strategy)}</div>
        </div>
    `).join('');
    
    // Network links
    document.getElementById('networkCompany').textContent = data.company || 'This Company';
    const enc = encodeURIComponent(data.company || '');
    document.getElementById('networkLinks').innerHTML = `
        <a href="https://www.linkedin.com/search/results/people/?keywords=${enc}%20recruiter" target="_blank" class="network-link">Find Recruiters</a>
        <a href="https://www.linkedin.com/search/results/people/?keywords=${enc}%20hiring%20manager" target="_blank" class="network-link">Find Executives</a>
        <a href="https://www.linkedin.com/search/results/people/?keywords=${enc}%20veteran" target="_blank" class="network-link">Find Veterans</a>
        <a href="https://www.glassdoor.com/Search/results.htm?keyword=${enc}" target="_blank" class="network-link">Glassdoor</a>
    `;
}

function generateTemplates(data) {
    const role = data.job_title || 'the position';
    const company = data.company || 'your company';
    const highlights = (data.analysis || []).filter(a => a.startsWith('Match:')).slice(0, 2).map(a => a.replace('Match:', '').split(' - ')[0].trim()).join(' and ') || 'relevant experience';
    const salary = data.salary_intel ? '$' + data.salary_intel.mid + 'K' : 'competitive market rate';
    
    document.getElementById('templateApplied').textContent = `Subject: Following Up - ${role} Application

Hi [Recruiter Name],

I recently submitted my application for the ${role} position at ${company} and wanted to follow up.

My background in ${highlights} aligns well with what you're looking for.

Would you have 15-20 minutes for a brief call this week?

Best regards,
[Your Name]
[Your Phone]`;

    document.getElementById('templateInterview').textContent = `Subject: Thank You - ${role} Interview

Hi [Interviewer Name],

Thank you for meeting with me today. Our conversation reinforced my enthusiasm for this opportunity.

I'm confident my experience with ${highlights} would allow me to contribute immediately.

Best regards,
[Your Name]`;

    document.getElementById('templateFollowup').textContent = `Subject: Checking In - ${role} Position

Hi [Recruiter Name],

I wanted to check in on the status of the ${role} position at ${company}.

Is there an updated timeline for next steps?

Best regards,
[Your Name]`;

    document.getElementById('templateNegotiate').textContent = `Subject: RE: ${role} Offer Discussion

Hi [Hiring Manager],

Thank you for the offer. I'm excited about joining ${company}.

Based on my background, I believe a base salary around ${salary} would be appropriate.

I'm committed to making this work.

Best regards,
[Your Name]`;

    showTemplate('applied');
}

function showTemplate(type) {
    currentTemplate = type;
    ['applied', 'interview', 'followup', 'negotiate'].forEach((t, i) => {
        const el = document.getElementById('template' + t.charAt(0).toUpperCase() + t.slice(1));
        if (el) el.style.display = t === type ? 'block' : 'none';
        document.querySelectorAll('.template-tab')[i]?.classList.toggle('active', t === type);
    });
}

// ==========================================================================
// MARKET INTEL
// ==========================================================================
async function fetchMarketIntel(jobDescription, jobTitle, company) {
    try {
        const response = await fetchWithRetry(API_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ request_type: 'market_intel', job_description: jobDescription, job_title: jobTitle, company })
        });
        if (!response.ok) return;
        const intel = await response.json();
        
        if (intel.salary_intel) {
            const s = intel.salary_intel;
            document.getElementById('salaryQuick').textContent = '$' + s.mid + 'K';
            document.getElementById('salaryRange').textContent = '$' + s.low + 'K - $' + s.high + 'K';
            if (analysisData) analysisData.salary_intel = s;
        }
        
        if (intel.timeline) {
            const t = intel.timeline;
            document.getElementById('offerDays').textContent = t.offer || '4-8 wks';
        }
        
        if (intel.competition) {
            document.getElementById('competitionLevel').textContent = intel.competition.level || 'Medium';
            document.getElementById('competitionDesc').textContent = intel.competition.reasoning ? intel.competition.reasoning.substring(0, 60) + '...' : '';
        }
    } catch (e) {
        console.error('Market intel error:', e);
    }
}

// ==========================================================================
// CHAT
// ==========================================================================
function askSuggestion(q) {
    document.getElementById('chatInput').value = q;
    sendChatMessage();
}

async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const msg = input.value.trim();
    if (!msg) return;
    if (!analysisData) { showToast('Analyze a job first'); return; }
    
    const container = document.getElementById('chatMessages');
    container.innerHTML += `<div class="user-message"><div class="user-bubble">${esc(msg)}</div></div>`;
    
    const loadingId = 'load-' + Date.now();
    container.innerHTML += `<div class="arti-take" id="${loadingId}"><img src="arti.png" alt="Arti" class="arti-avatar-small"><div class="arti-bubble">Thinking...</div></div>`;
    container.scrollTop = container.scrollHeight;
    input.value = '';
    document.getElementById('chatSuggestions').style.display = 'none';
    
    try {
        const response = await fetchWithRetry(API_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                request_type: 'ask_expert',
                question: msg,
                job_description: document.getElementById('jobDescription').value,
                resume_text: document.getElementById('resumeText').value,
                analysis_data: analysisData,
                chat_history: chatHistory
            })
        });
        if (!response.ok) throw new Error('Failed');
        const data = await response.json();
        chatHistory.push({ role: 'user', content: msg }, { role: 'assistant', content: data.response });
        document.getElementById(loadingId).querySelector('.arti-bubble').innerHTML = esc(data.response).replace(/\n/g, '<br>');
        container.scrollTop = container.scrollHeight;
    } catch (e) {
        document.getElementById(loadingId).querySelector('.arti-bubble').textContent = 'Sorry, please try again.';
    }
}

// ==========================================================================
// COVER LETTER
// ==========================================================================
async function generateCoverLetter() {
    if (!analysisData) return;
    const btn = document.getElementById('generateCoverLetterBtn');
    btn.disabled = true;
    btn.textContent = 'Generating...';
    try {
        const response = await fetchWithRetry(API_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                request_type: 'generate_intro_email',
                job_description: document.getElementById('jobDescription').value,
                resume_text: document.getElementById('resumeText').value,
                analysis_data: analysisData
            })
        });
        if (!response.ok) throw new Error('Failed');
        const data = await response.json();
        document.getElementById('coverLetterPlaceholder').style.display = 'none';
        document.getElementById('coverLetterDisplay').style.display = 'block';
        document.getElementById('coverLetterDisplay').textContent = data.intro_email;
        document.getElementById('copyCLBtn').style.display = 'inline-flex';
    } catch (e) {
        showToast('Failed to generate email.');
        btn.disabled = false;
        btn.textContent = 'Generate Intro Email';
    }
}

// ==========================================================================
// COPY
// ==========================================================================
function copyKeywords() {
    const missing = Array.from(document.querySelectorAll('.keyword-tag.missing')).map(el => el.textContent).join(', ');
    if (missing) {
        navigator.clipboard.writeText(missing).then(() => showToast('Copied!'));
    } else {
        showToast('No missing keywords to copy');
    }
}

function copyResume() {
    navigator.clipboard.writeText(document.getElementById('resumeOutput').textContent).then(() => showToast('Copied!'));
}

function copyCoverLetter() {
    navigator.clipboard.writeText(document.getElementById('coverLetterDisplay').textContent).then(() => showToast('Copied!'));
}

function copyCurrentTemplate() {
    const el = document.getElementById('template' + currentTemplate.charAt(0).toUpperCase() + currentTemplate.slice(1));
    if (el) navigator.clipboard.writeText(el.textContent).then(() => showToast('Copied!'));
}

// ==========================================================================
// TRACKER
// ==========================================================================
function initTracker() {
    const s = localStorage.getItem(TRACKER_STORAGE_KEY);
    if (s) try { trackedJobs = JSON.parse(s); renderTracker(); } catch(e) {}
}

function saveToTracker() {
    if (!analysisData) return;
    const job = {
        id: Date.now(),
        company: analysisData.company || 'Unknown',
        role: analysisData.job_title || 'Unknown Role',
        score: analysisData.score || 0,
        status: 'saved',
        date: new Date().toLocaleDateString(),
        jd: document.getElementById('jobDescription').value.substring(0, 500),
        analysis: analysisData
    };
    if (trackedJobs.some(j => j.company === job.company && j.role === job.role)) {
        showToast('Already tracked!');
        return;
    }
    trackedJobs.unshift(job);
    localStorage.setItem(TRACKER_STORAGE_KEY, JSON.stringify(trackedJobs));
    renderTracker();
    updateStatsDisplay();
    const btn = document.getElementById('saveToTrackerBtn');
    btn.textContent = 'Saved!';
    btn.disabled = true;
    setTimeout(() => { btn.textContent = 'Save to Tracker'; btn.disabled = false; }, 2000);
}

function renderTracker() {
    const section = document.getElementById('trackerSection');
    const countEl = document.getElementById('trackerCount');
    const tbody = document.getElementById('trackerBody');
    
    if (!section || !tbody) return;
    
    // Show tracker section only if there are tracked jobs
    section.style.display = trackedJobs.length > 0 ? 'block' : 'none';
    
    if (countEl) {
        countEl.textContent = trackedJobs.length + ' job' + (trackedJobs.length !== 1 ? 's' : '');
    }
    
    tbody.innerHTML = trackedJobs.map(job => `
        <tr>
            <td><strong>${esc(job.company)}</strong></td>
            <td>${esc(job.role)}</td>
            <td><span class="intel-badge ${job.score >= 75 ? 'green' : job.score >= 50 ? 'gold' : 'clay'}">${job.score}%</span></td>
            <td><select onchange="updateJobStatus(${job.id}, this.value)" style="padding:4px;font-size:11px;border:1px solid var(--ink-black);border-radius:3px;">
                <option value="saved" ${job.status==='saved'?'selected':''}>Saved</option>
                <option value="applied" ${job.status==='applied'?'selected':''}>Applied</option>
                <option value="interviewing" ${job.status==='interviewing'?'selected':''}>Interviewing</option>
                <option value="offered" ${job.status==='offered'?'selected':''}>Offered</option>
                <option value="rejected" ${job.status==='rejected'?'selected':''}>Rejected</option>
            </select></td>
            <td><div class="tracker-actions"><button class="tracker-btn" onclick="loadTrackedJob(${job.id})">Load</button><button class="tracker-btn" onclick="deleteTrackedJob(${job.id})">X</button></div></td>
        </tr>
    `).join('');
}

function updateJobStatus(id, status) {
    const job = trackedJobs.find(j => j.id === id);
    if (job) { job.status = status; localStorage.setItem(TRACKER_STORAGE_KEY, JSON.stringify(trackedJobs)); updateStatsDisplay(); }
}

function loadTrackedJob(id) {
    const job = trackedJobs.find(j => j.id === id);
    if (job && job.analysis) {
        document.getElementById('jobDescription').value = job.jd || '';
        analysisData = job.analysis;
        renderResults(job.analysis);
        document.getElementById('analysisResults').style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function deleteTrackedJob(id) {
    if (confirm('Remove this job?')) {
        trackedJobs = trackedJobs.filter(j => j.id !== id);
        localStorage.setItem(TRACKER_STORAGE_KEY, JSON.stringify(trackedJobs));
        renderTracker();
        updateStatsDisplay();
    }
}

// ==========================================================================
// UTILITIES
// ==========================================================================
function esc(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showInlineError(msg) {
    document.getElementById('inlineErrorText').textContent = msg;
    document.getElementById('inlineError').classList.add('show');
}

function hideInlineError() {
    document.getElementById('inlineError').classList.remove('show');
}

function showToast(msg) {
    document.getElementById('errorToastText').textContent = msg;
    document.getElementById('errorToast').classList.add('show');
    setTimeout(() => document.getElementById('errorToast').classList.remove('show'), 3000);
}

function hideErrorToast() {
    document.getElementById('errorToast').classList.remove('show');
}

function clearAll() {
    document.getElementById('jobDescription').value = '';
    document.getElementById('analysisResults').style.display = 'none';
    analysisData = null;
    chatHistory = [];
    hideInlineError();
}

function loadSampleData() {
    document.getElementById('resumeText').value = `SARAH JOHNSON
Director of Federal Sales | TS/SCI Cleared | 15+ Years in Defense

EXECUTIVE SUMMARY
Results-driven federal sales leader with 15+ years driving revenue growth across the Intelligence Community and Department of Defense. Proven track record of winning $500M+ in contract awards through strategic capture leadership.

EXPERIENCE

Director of Federal Sales | ACME Defense Technologies | 2019-Present
- Lead $150M annual quota team selling cloud and cybersecurity solutions to IC and DoD
- Won $200M IDIQ contract with NGA through strategic capture
- Built executive relationships with CIOs across 12 agencies

Senior Account Executive | CloudTech Federal | 2014-2019
- Exceeded quota 5 consecutive years selling AWS GovCloud solutions
- Closed $75M in new business across DIA, NSA, and CIA accounts

CLEARANCE: TS/SCI with Full Scope Polygraph
EDUCATION: MBA, Georgetown University | BS Computer Science, Virginia Tech`;

    document.getElementById('jobDescription').value = `Director of Federal Sales - Intelligence Community

Location: Reston, VA (Hybrid)
Clearance: TS/SCI with Polygraph Required

We're seeking a Director of Federal Sales to lead our IC business unit with a $100M+ quota.

Requirements:
- 10+ years federal sales, 5+ in IC
- Track record exceeding $75M+ quotas
- Cloud, cybersecurity, or AI/ML experience
- Active TS/SCI with polygraph
- MBA preferred

Compensation: $200-250K base + commission`;

    checkWorkflowProgress();
}
</script>
</body>
</html>